version: "3.8"
services:
  # app:
  #   build: .
  #   container_name: openai-little-app
  #   restart: always
  #   env_file:
  #     - ./.env
  #   ports:
  #     - "20492:20491"
  #     - "30492:30491"
  #   depends_on:
  #     - mysql
  mysql:
    image: mysql:8.2
    container_name: nodeopenai-mysql2
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: apppass
      MYSQL_DATABASE: usage_stats
      MYSQL_USER: appuser
      MYSQL_PASSWORD: apppass
      TZ: Asia/Shanghai
    ports:
      - "${DB_PORT}:3306"
    volumes:
      - ./dbdata:/var/lib/mysql
      - ./mysql-custom.cnf:/etc/mysql/conf.d/custom.cnf:ro
    # 资源限制配置 (优化性能)
    deploy:
      resources:
        limits:
          cpus: '2.0'          # 最多使用2个CPU核心
          memory: 2G           # 最大内存2GB
        reservations:
          cpus: '1.0'          # 保证至少1个CPU核心
          memory: 1G           # 保证至少1GB内存
    # MySQL性能优化命令参数
    command:
      - --max_connections=500
      - --innodb_buffer_pool_size=1G
      - --innodb_log_file_size=256M
      - --sort_buffer_size=4M
      - --read_buffer_size=2M
      - --read_rnd_buffer_size=2M
      - --join_buffer_size=4M
      - --tmp_table_size=64M
      - --max_heap_table_size=64M
      - --innodb_flush_log_at_trx_commit=2
      - --innodb_flush_method=O_DIRECT
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
networks: {}