# OpenAI Little - å¼€å‘è®°å½•æ–‡æ¡£

> **æ›´æ–°æ—¶é—´**: 2025-10-18
> **ç‰ˆæœ¬**: 1.11.0 (å›¾åƒä¸­é—´ä»¶æ—¥å¿—æ¨é€ + åŠ¨æ€å®¡æ ¸é…ç½®)
> **ä½œè€…**: Liu Jiarong  

## ğŸ—ï¸ é¡¹ç›®æ¶æ„æ¦‚è§ˆ

### æ ¸å¿ƒæœåŠ¡æ¶æ„
```
openAILittle/
â”œâ”€â”€ ä¸»ä»£ç†æœåŠ¡ (index.js)           # ç«¯å£: 7104 (20491å®¹å™¨å†…)
â”œâ”€â”€ ç»Ÿè®¡æœåŠ¡ (statsServer.js)       # ç«¯å£: 7103 (30491å®¹å™¨å†…)  
â”œâ”€â”€ MySQLæ•°æ®åº“                     # ç«¯å£: 7102 (usage_stats)
â””â”€â”€ Dockerå®¹å™¨åŒ–éƒ¨ç½²                # docker-compose.yml
```

### æŠ€æœ¯æ ˆ
- **è¿è¡Œç¯å¢ƒ**: Node.js 18 + Express.js
- **æ•°æ®åº“**: MySQL 8+ (usage_stats)
- **å®¹å™¨åŒ–**: Docker + Docker Compose
- **åŒ…ç®¡ç†**: pnpm
- **ä»£ç†**: http-proxy-middleware
- **é™æµ**: express-rate-limit
- **æ—¶é—´å¤„ç†**: moment.js

## ğŸ”„ æ”¯æŒçš„AIæ¨¡å‹è·¯ç”±

| è·¯ç”±å‰ç¼€ | ç›®æ ‡æœåŠ¡ | ç«¯å£é…ç½® | æ”¯æŒåŠŸèƒ½ | çŠ¶æ€ |
|---------|---------|----------|----------|------|
| `/v1/*` | OpenAI API | TARGET_SERVER | æ–‡æœ¬ç”Ÿæˆã€TTS | âœ… è¿è¡Œä¸­ |
| `/google/*` | Google Gemini | TARGET_SERVER_GEMIN | æ–‡æœ¬ç”Ÿæˆã€å¤šæ¨¡æ€ | âœ… è¿è¡Œä¸­ |
| `/chatnio/*` | ChatNio | TARGET_SERVER | æ–‡æœ¬ç”Ÿæˆ | âœ… è¿è¡Œä¸­ |
| `/freelyai/*` | FreelyAI | TARGET_SERVER | æ–‡æœ¬ç”Ÿæˆ | âœ… è¿è¡Œä¸­ |
| `/freeopenai/*` | Free OpenAI | TARGET_SERVER | æ–‡æœ¬ç”Ÿæˆ | âœ… è¿è¡Œä¸­ |
| `/freegemini/*` | Free Gemini | TARGET_SERVER_GEMIN | æ–‡æœ¬ç”Ÿæˆã€å¤šæ¨¡æ€ | âœ… è¿è¡Œä¸­ |
| `/cloudflare/*` | Cloudflare AI | https://api.cloudflare.com | å›¾åƒç”Ÿæˆã€æ–‡ç”Ÿå›¾ | âœ… è¿è¡Œä¸­ |
| `/siliconflow/*` | SiliconFlow AI | https://api.siliconflow.cn | å›¾åƒç”Ÿæˆã€å›¾ç”Ÿå›¾ | âœ… è¿è¡Œä¸­ |
| `/image-middleware/*` | æœ¬åœ°å›¾åƒä¸­é—´ä»¶ | IMAGE_MIDDLEWARE_TARGET | å›¾åƒ/è§†é¢‘ç”Ÿæˆ | ğŸ†• æ–°å¢ |

## ğŸ›¡ï¸ å®‰å…¨é˜²æŠ¤ç³»ç»Ÿ

### å¤šå±‚å®‰å…¨æœºåˆ¶
1. **é»‘ç™½åå•æ§åˆ¶**
   - `whitelist.json` - ç”¨æˆ·IDå’ŒIPç™½åå•
   - `BlacklistedUsers.txt` - ç”¨æˆ·é»‘åå•
   - `BlacklistedIPs.txt` - IPåœ°å€é»‘åå•

2. **å†…å®¹å®‰å…¨è¿‡æ»¤**
   - `Sensitive.txt` - æ•æ„Ÿè¯åˆ—è¡¨
   - `sensitive_patterns.json` - æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼
   - `filterConfig.json` - æ¨¡å‹çº§åˆ«è¿‡æ»¤é…ç½®

3. **æ¨¡å‹è®¿é—®æ§åˆ¶**
   - `restrictedUsers.json` - åŸºäºç”¨æˆ·çš„æ¨¡å‹æƒé™é™åˆ¶
   - `FREELYAI_WHITELIST` - FreelyAIæ¨¡å‹ç™½åå•
   - `ROBOT_WHITELIST` - OpenAIè·¯ç”±æ¨¡å‹ç™½åå•

4. **ğŸ†• å†…å®¹å®¡æŸ¥ç³»ç»Ÿ** (2025-09-11 æ–°å¢)
   - `modules/moderationConfig.js` - å†…å®¹å®¡æŸ¥é…ç½®
   - `middleware/contentModerationMiddleware.js` - å®¡æŸ¥ä¸­é—´ä»¶
   - `modules/databaseModerationConfig.js` - æ•°æ®åº“é©±åŠ¨çš„å®¡æ ¸é…ç½®
   - é›†æˆæ™ºè°±AIå†…å®¹å®‰å…¨API
   - æ”¯æŒå®æ—¶å†…å®¹å®¡æŸ¥å’Œé£é™©æ£€æµ‹
   - **ğŸ†• æ•°æ®åº“é…ç½®æ”¯æŒ** (2025-10-18 æ–°å¢)
     - å‰ç«¯å¯è§†åŒ–é…ç½®å®¡æ ¸è§„åˆ™
     - å®æ—¶ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯æœåŠ¡
     - æ”¯æŒè·¯ç”±å’Œæ¨¡å‹çº§åˆ«çš„å®¡æ ¸ç­–ç•¥

## âš¡ æ™ºèƒ½é™æµç³»ç»Ÿ

### é™æµé…ç½®æ–‡ä»¶
- `modules/modelRateLimits.js` - æ¨¡å‹çº§åˆ«é™æµç­–ç•¥
- `modules/chatnioRateLimits.js` - ChatNioä¸“å±é™æµ
- `modules/auxiliaryModels.js` - è¾…åŠ©æ¨¡å‹åˆ—è¡¨

### é™æµç­–ç•¥
- **æ—¶é—´çª—å£é™æµ** - æŒ‡å®šæ—¶é—´å†…è¯·æ±‚æ¬¡æ•°
- **æ¯æ—¥æ€»é‡é™åˆ¶** - æ—¥æœ€å¤§è¯·æ±‚æ•°æ§åˆ¶
- **æ¨¡å‹çº§åˆ«é™æµ** - ä¸åŒæ¨¡å‹ä¸åŒç­–ç•¥
- **åæ»¥ç”¨æœºåˆ¶** - é‡å¤è¯·æ±‚æ£€æµ‹ã€é¢‘ç‡æ§åˆ¶

## ğŸ”§ ä¸­é—´ä»¶ç³»ç»Ÿ

### ç°æœ‰ä¸­é—´ä»¶
| ä¸­é—´ä»¶æ–‡ä»¶ | åŠŸèƒ½æè¿° | çŠ¶æ€ |
|-----------|----------|------|
| `limitRequestBodyLength.js` | è¯·æ±‚ä½“é•¿åº¦é™åˆ¶ | âœ… æ´»è·ƒ |
| `loggingMiddleware.js` | æ—¥å¿—è®°å½•ä¸­é—´ä»¶ | âœ… æ´»è·ƒ |
| `modifyRequestBodyMiddleware.js` | è¯·æ±‚ä½“ä¿®æ”¹å¤„ç† | âœ… æ´»è·ƒ |
| `contentModerationMiddleware.js` | å†…å®¹å®¡æŸ¥ä¸­é—´ä»¶ | âœ… æ´»è·ƒ |

### ğŸ†• å›¾åƒä¸­é—´ä»¶æ—¥å¿—æ”¶é›†ç³»ç»Ÿ (2025-10-18 æ–°å¢)
**æ¶æ„è®¾è®¡**
- **æœ¬åœ°ä¸­é—´ä»¶**: ç‹¬ç«‹çš„Node.jsæœåŠ¡ï¼Œè¿è¡Œåœ¨6053ç«¯å£
- **æ—¥å¿—æ”¶é›†å™¨**: æ‹¦æˆªconsoleè¾“å‡ºï¼Œå­˜å‚¨åˆ°å†…å­˜ç¼“å†²åŒº
- **HTTPæ¥å£**: æä¾›`/logs`å’Œ`/health`ç«¯ç‚¹
- **ä¸»æœåŠ¡èšåˆ**: é€šè¿‡`/api/logs/middleware`è·å–ä¸­é—´ä»¶æ—¥å¿—
- **å‰ç«¯å±•ç¤º**: æ”¯æŒæ¥æºç­›é€‰çš„ç»Ÿä¸€æ—¥å¿—ç•Œé¢

**æŠ€æœ¯å®ç°**
```javascript
// ä¸­é—´ä»¶æ—¥å¿—æ”¶é›†å™¨
class LogCollector {
  constructor() {
    this.setupLogCollection(); // æ‹¦æˆªconsoleæ–¹æ³•
  }
  getLogs({ limit, level }) { /* è¿”å›ç»“æ„åŒ–æ—¥å¿— */ }
}

// ä¸»æœåŠ¡æ—¥å¿—èšåˆ
router.get('/logs/middleware', async (req, res) => {
  const response = await fetch(`${IMAGE_MIDDLEWARE_TARGET}/logs`);
  // è¿”å›èšåˆåçš„æ—¥å¿—æ•°æ®
});

// å‰ç«¯æ—¥å¿—å±•ç¤º
SystemLogsView.vue:
- æ¥æºé€‰æ‹©å™¨ï¼šlocal,middleware,all
- å®æ—¶ç»Ÿè®¡ï¼šå„æœåŠ¡æ—¥å¿—æ•°é‡åˆ†å¸ƒ
- çº§åˆ«è¿‡æ»¤ï¼šinfo,warn,error,debug
```

**æ”¯æŒçš„åŠŸèƒ½**
- å®æ—¶æ—¥å¿—æ”¶é›†ï¼šæ‹¦æˆªconsole.log/warn/error/debug
- å†…å­˜ç¼“å†²ï¼šæœ€å¤šä¿å­˜1000æ¡æ—¥å¿—è®°å½•
- HTTPæ¥å£ï¼šRESTful APIè·å–æ—¥å¿—æ•°æ®
- èšåˆå±•ç¤ºï¼šå‰ç«¯ç»Ÿä¸€æŸ¥çœ‹ä¸»æœåŠ¡+ä¸­é—´ä»¶æ—¥å¿—
- æ¥æºæ ‡è¯†ï¼šæ—¥å¿—æ¡ç›®åŒ…å«æœåŠ¡æ¥æºæ ‡è¯†

### ä¸­é—´ä»¶æ‰§è¡Œé¡ºåº (index.js)
```javascript
1. restrictGeminiModelAccess
2. loggingMiddleware
3. contentModerationMiddleware  // åŠ¨æ€é…ç½®æ”¯æŒ
4. å…¶ä»–è·¯ç”±ç‰¹å®šä¸­é—´ä»¶...
```

## ğŸ“Š ç›‘æ§é€šçŸ¥ç³»ç»Ÿ

### é€šçŸ¥æ¸ é“
- `notices/pushDeerNotifier.js` - ç§»åŠ¨ç«¯æ¨é€
- `notices/larkNotifier.js` - é£ä¹¦ä¼ä¸šé€šçŸ¥
- `notices/dingTalkNotifier.js` - é’‰é’‰å›¢é˜Ÿé€šçŸ¥
- `notices/ntfyNotifier.js` - è½»é‡çº§æ¨é€

### ğŸ†• æ•°æ®åº“é©±åŠ¨çš„é€šçŸ¥é…ç½®ç³»ç»Ÿ (2025-09-14)
**æ ¸å¿ƒæ”¹è¿›**
- ä»ç¡¬ç¼–ç é€šçŸ¥é…ç½®è¿ç§»åˆ°æ•°æ®åº“é©±åŠ¨çš„åŠ¨æ€é…ç½®ç³»ç»Ÿ
- æ”¯æŒé€šè¿‡å‰ç«¯ç•Œé¢å®æ—¶ç®¡ç†æ‰€æœ‰é€šçŸ¥æ¸ é“
- å®ç°5åˆ†é’Ÿç¼“å­˜æœºåˆ¶ï¼Œä¼˜åŒ–é…ç½®åŠ è½½æ€§èƒ½
- å®Œå…¨ä¿æŒåŸæœ‰é€šçŸ¥é“¾è·¯çš„åŠŸèƒ½æ­£å¸¸

**APIæ¥å£**
- `GET /api/stats/notification-configs` - è·å–é€šçŸ¥é…ç½®åˆ—è¡¨
- `POST /api/stats/notification-configs` - æ·»åŠ é€šçŸ¥é…ç½®
- `PUT /api/stats/notification-configs/:id` - æ›´æ–°é€šçŸ¥é…ç½®
- `DELETE /api/stats/notification-configs/:id` - åˆ é™¤é€šçŸ¥é…ç½®
- `POST /api/stats/notification-configs/test` - æµ‹è¯•é€šçŸ¥å‘é€

**å‰ç«¯ç®¡ç†ç•Œé¢**
- åœ¨å†…å®¹å®¡æ ¸ç®¡ç†é¡µé¢æ–°å¢"é€šçŸ¥é…ç½®"æ ‡ç­¾é¡µ
- æ”¯æŒå››ç§é€šçŸ¥ç±»å‹çš„å®Œæ•´é…ç½®ï¼šPushDeerã€Larkã€DingTalkã€Ntfy
- åŠ¨æ€è¡¨å•éªŒè¯ï¼Œæ ¹æ®é€šçŸ¥ç±»å‹æ˜¾ç¤ºç›¸åº”é…ç½®å­—æ®µ
- çŠ¶æ€åˆ‡æ¢ã€æµ‹è¯•å‘é€ç­‰æ“ä½œåŠŸèƒ½

### ç›‘æ§é¡¹ç›®
- è¯·æ±‚é¢‘ç‡å¼‚å¸¸
- å®‰å…¨è§„åˆ™è§¦å‘
- é™æµäº‹ä»¶è§¦å‘
- ç³»ç»Ÿé”™è¯¯å’Œå¼‚å¸¸
- ğŸ†• å†…å®¹å®¡æŸ¥å¤±è´¥äº‹ä»¶
- ğŸ†• é€šçŸ¥é…ç½®å˜æ›´äº‹ä»¶

## ğŸ—„ï¸ æ•°æ®å±‚

### MySQLæ•°æ®åº“
- **è¿æ¥é…ç½®**: `db/index.js`
- **ç»Ÿè®¡API**: `router/statsRoutes.js`
- **æ•°æ®åº“å**: usage_stats
- **ç”¨æˆ·è®¤è¯**: appuser/apppass

### ç»Ÿè®¡æœåŠ¡ (statsServer.js)
- **ç‹¬ç«‹ç«¯å£**: 7103 (30491å®¹å™¨å†…)
- **CORSæ”¯æŒ**: å‰ç«¯æ•°æ®å¯è§†åŒ–
- **APIè·¯ç”±**: `/api/*`

## ğŸ†• å†…å®¹å®¡æŸ¥åŠŸèƒ½è¯¦æƒ… (2025-09-11 æ›´æ–°è‡³2025-10-18)

#### é…ç½®æ¶æ„å‡çº§
**é™æ€é…ç½® â†’ åŠ¨æ€æ•°æ®åº“é…ç½®**
- `modules/moderationConfig.js` - é™æ€fallbacké…ç½®
- `modules/databaseModerationConfig.js` - æ•°æ®åº“é…ç½®åŠ è½½å™¨
- `middleware/contentModerationMiddleware.js` - æ”¯æŒåŠ¨æ€é…ç½®çš„å®¡æ ¸ä¸­é—´ä»¶

#### æ•°æ®åº“é…ç½®ç³»ç»Ÿ
```sql
-- system_configs è¡¨å­˜å‚¨å®¡æ ¸é…ç½®
config_type: 'MODERATION'
config_key: 'global' | '/chatnio' | '/v1' | '/freelyai' ...
config_value: {
  enabled: true,
  models: {
    'gpt-5': { enabled: true },
    'default': { enabled: false }
  },
  description: 'è·¯ç”±æè¿°'
}
```

#### é…ç½®åŠ è½½æœºåˆ¶
```javascript
// æ•°æ®åº“é…ç½®ä¼˜å…ˆï¼Œæ–‡ä»¶é…ç½®ä½œä¸ºfallback
async getCurrentConfig() {
  if (this.useDatabaseConfig) {
    const globalConfig = await databaseModerationConfig.getGlobalConfig();
    return { global: globalConfig };
  }
  return this.config; // æ–‡ä»¶é…ç½®
}

// æ”¯æŒè·¯ç”±å’Œæ¨¡å‹çº§åˆ«çš„å®¡æ ¸ç­–ç•¥
async shouldModerate(routePrefix, model) {
  return await databaseModerationConfig.shouldModerate(routePrefix, model);
}
```

#### å‰ç«¯é…ç½®ç®¡ç†
- **å¯è§†åŒ–ç•Œé¢**: é€šè¿‡å‰ç«¯ç®¡ç†ç•Œé¢é…ç½®å®¡æ ¸è§„åˆ™
- **å®æ—¶ç”Ÿæ•ˆ**: é…ç½®ä¿®æ”¹å2åˆ†é’Ÿå†…è‡ªåŠ¨ç”Ÿæ•ˆ
- **è·¯ç”±ç®¡ç†**: æ”¯æŒä¸åŒè·¯ç”±çš„ç‹¬ç«‹å®¡æ ¸ç­–ç•¥
- **æ¨¡å‹æ§åˆ¶**: ç²¾ç¡®åˆ°æ¨¡å‹çº§åˆ«çš„å®¡æ ¸å¼€å…³

#### å½“å‰é…ç½®çŠ¶æ€ (/chatnio è·¯ç”±)
```javascript
{
  enabled: true,
  models: {
    "gpt-5": { enabled: true },
    "dall-e-img": { enabled: true },
    "gpt-5-mini": { enabled: true },
    "gpt-5-nano": { enabled: true },
    "gpt-4o-mini": { enabled: true },
    "gpt-4.1-nano": { enabled: true },
    "claude-sonnet-4-5": { enabled: true },
    "gemini-flash-latest": { enabled: true },
    "claude-opus-4-1-20250805": { enabled: true },
    "gemini-flash-lite-latest": { enabled: true },
    "deepseek-ai/DeepSeek-V3.1": { enabled: false },
    "default": { enabled: false }
  },
  description: "ChatNio å¹³å°è·¯ç”±"
}
```

### æ™ºè°±AIå†…å®¹å®‰å…¨APIé›†æˆ
- **APIç«¯ç‚¹**: `https://open.bigmodel.cn/api/paas/v4/moderations`
- **æ¨¡å‹**: `moderation`
- **è®¤è¯**: Bearer token (ZHIPU_API_KEY)
- **è¾“å…¥é™åˆ¶**: æœ€å¤§2000å­—ç¬¦
- **é£é™©ç­‰çº§**: PASS(é€šè¿‡) / REVIEW(å¯ç–‘,æ‹¦æˆª) / REJECT(è¿è§„,æ‹¦æˆª)

### å®¡æŸ¥æµç¨‹
```
1. è¯·æ±‚åˆ°è¾¾ â†’ 2. æ£€æŸ¥è·¯ç”±/æ¨¡å‹é…ç½® â†’ 3. æå–å†…å®¹ 
â†’ 4. è°ƒç”¨æ™ºè°±API â†’ 5. è§£æç»“æœ â†’ 6. é€šè¿‡/æ‹¦æˆª
```

### ç¼“å­˜æœºåˆ¶
- **ç¼“å­˜æ—¶é—´**: 30åˆ†é’Ÿ
- **ç¼“å­˜æ¸…ç†**: æ¯10åˆ†é’Ÿè‡ªåŠ¨æ¸…ç†
- **é…ç½®é‡è½½**: æ¯5åˆ†é’Ÿçƒ­æ›´æ–°

## ğŸ³ å®¹å™¨åŒ–éƒ¨ç½²

### Dockeré…ç½®
- **åŸºç¡€é•œåƒ**: node:18-alpine
- **å·¥ä½œç›®å½•**: /app
- **åŒ…ç®¡ç†**: pnpm
- **ç«¯å£æš´éœ²**: 20491, 30491

### Docker ComposeæœåŠ¡
```yaml
services:
  mysql:
    image: mysql:8.2
    container_name: nodeopenai-mysql2
    ports: ["7102:3306"]
    environment:
      MYSQL_DATABASE: usage_stats
      MYSQL_USER: appuser
      MYSQL_PASSWORD: apppass
```

## ğŸ”‘ ç¯å¢ƒå˜é‡é…ç½®

### æ ¸å¿ƒé…ç½® (.env)
```bash
# æœåŠ¡ç«¯ç‚¹
TARGET_SERVER=http://10.31.31.135:7068
TARGET_SERVER_GEMIN=https://proxy.liujiarong.online/google
TARGET_SERVER_FEISHU=https://open.feishu.cn/open-apis/bot/v2/hook/

# æ•°æ®åº“é…ç½®
DB_HOST=127.0.0.1
DB_USER=appuser
DB_PASSWORD=apppass
DB_NAME=usage_stats
DB_PORT=7102

# ç«¯å£é…ç½®
STATS_PORT=7103
MAIN_PORT=7104

# ğŸ†• å†…å®¹å®¡æŸ¥é…ç½®
ZHIPU_API_KEY=c5a84cde65d86beb070277e68a0d41a5.qoo9MSsDXWiENir3

# ğŸ†• å›¾åƒä¸­é—´ä»¶é…ç½®
IMAGE_MIDDLEWARE_TARGET=http://localhost:6053

# æ¨¡å‹ç™½åå•
FREELYAI_WHITELIST=deepseek-v3,deepseek-r1,glm-4-flashx-250414...
ROBOT_WHITELIST=deepseek-v3,deepseek-r1,gpt-4.5-preview...
```

## ğŸ“‹ å¼€å‘è®°å½•

### æœ€è¿‘æ›´æ–° (2025-09-11)
1. âœ… **æ–°å¢å†…å®¹å®¡æŸ¥åŠŸèƒ½**
   - åˆ›å»º `modules/moderationConfig.js` é…ç½®æ–‡ä»¶
   - å®ç° `middleware/contentModerationMiddleware.js` ä¸­é—´ä»¶
   - é›†æˆæ™ºè°±AIå†…å®¹å®‰å…¨API
   - æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—

2. âœ… **åŠŸèƒ½éªŒè¯å®Œæˆ**
   - APIè°ƒç”¨æˆåŠŸ (çŠ¶æ€ç 200)
   - å“åº”è§£ææ­£ç¡® (risk_level: PASS/REVIEW/REJECT)
   - ç¼“å­˜æœºåˆ¶æ­£å¸¸å·¥ä½œ
   - é”™è¯¯å¤„ç†å®Œå–„

### æµ‹è¯•çŠ¶æ€
- âœ… æ­£å¸¸å†…å®¹é€šè¿‡å®¡æŸ¥ (PASS)
- âœ… APIå“åº”æ ¼å¼è§£ææ­£ç¡®
- âœ… ç¼“å­˜å’Œé…ç½®çƒ­æ›´æ–°æ­£å¸¸
- âœ… æ—¥å¿—è®°å½•è¯¦ç»†å®Œæ•´

### å¾…æµ‹è¯•é¡¹ç›®
- â³ è¿è§„å†…å®¹æ‹¦æˆªæµ‹è¯• (REJECT)
- â³ å¯ç–‘å†…å®¹å¤„ç†æµ‹è¯• (REVIEW)
- â³ é•¿æ–‡æœ¬æˆªæ–­æµ‹è¯• (>2000å­—ç¬¦)
- â³ APIé”™è¯¯å¤„ç†æµ‹è¯•

## ğŸš€ æ€§èƒ½ä¼˜åŒ–è®°å½•

### å·²å®ç°ä¼˜åŒ–
1. **ç¼“å­˜ç³»ç»Ÿ**: å†…å®¹å®¡æŸ¥ç»“æœç¼“å­˜30åˆ†é’Ÿ
2. **å¼‚æ­¥å¤„ç†**: æ—¥å¿—ä¸­é—´ä»¶æ— é˜»å¡å¤„ç†
3. **é…ç½®çƒ­æ›´æ–°**: é¿å…é‡å¯æœåŠ¡
4. **è¯·æ±‚å¤ç”¨**: ç›¸åŒå†…å®¹å¤ç”¨å®¡æŸ¥ç»“æœ
5. **é”™è¯¯å®¹é”™**: APIé”™è¯¯æ—¶é»˜è®¤é€šè¿‡ï¼Œä¸é˜»å¡æœåŠ¡

### æ€§èƒ½æŒ‡æ ‡
- **å†…å®¹å®¡æŸ¥å»¶è¿Ÿ**: ~1-2ç§’ (å«ç½‘ç»œè¯·æ±‚)
- **ç¼“å­˜å‘½ä¸­ç‡**: é¢„æœŸ >60% (ç›¸åŒå†…å®¹é‡å¤è¯·æ±‚)
- **APIè°ƒç”¨æˆæœ¬**: 1.2å…ƒ/ä¸‡æ¬¡ (æ™ºè°±AIå®šä»·)

## ğŸ› ï¸ å¸¸ç”¨å‘½ä»¤

### å¼€å‘ç¯å¢ƒ
```bash
# å¯åŠ¨æœåŠ¡
pnpm start                    # åŒæ—¶å¯åŠ¨ä¸»æœåŠ¡å’Œç»Ÿè®¡æœåŠ¡
pnpm run start:main          # ä»…å¯åŠ¨ä¸»æœåŠ¡ (ç«¯å£7104)
pnpm run start:stats         # ä»…å¯åŠ¨ç»Ÿè®¡æœåŠ¡ (ç«¯å£7103)

# æ•°æ®åº“æ“ä½œ
docker-compose up -d mysql   # å¯åŠ¨MySQLå®¹å™¨
docker-compose ps           # æŸ¥çœ‹å®¹å™¨çŠ¶æ€
```

### è°ƒè¯•å’Œç›‘æ§
```bash
# å®æ—¶æ—¥å¿—
tail -f logs/app.log        # åº”ç”¨æ—¥å¿—
docker logs -f nodeopenai-mysql2  # æ•°æ®åº“æ—¥å¿—

# å†…å®¹å®¡æŸ¥è°ƒè¯•
grep "Content Moderation" logs/app.log  # è¿‡æ»¤å®¡æŸ¥æ—¥å¿—
```

## ğŸ” æ•…éšœæ’æŸ¥æŒ‡å—

### å†…å®¹å®¡æŸ¥ç›¸å…³é—®é¢˜
1. **APIè°ƒç”¨å¤±è´¥ (404)**
   - æ£€æŸ¥ `ZHIPU_API_KEY` æ˜¯å¦æ­£ç¡®é…ç½®
   - éªŒè¯APIç«¯ç‚¹ `https://open.bigmodel.cn/api/paas/v4/moderations`

2. **å®¡æŸ¥æœªè§¦å‘**
   - ç¡®è®¤ `global.enabled = true`
   - æ£€æŸ¥è·¯ç”±å’Œæ¨¡å‹é…ç½®æ˜¯å¦åŒ¹é…
   - æŸ¥çœ‹ `[Content Moderation]` æ—¥å¿—

3. **å†…å®¹é•¿åº¦è¶…é™**
   - æ™ºè°±AIé™åˆ¶æ–‡æœ¬æœ€å¤§2000å­—ç¬¦
   - ä¸­é—´ä»¶ä¼šè‡ªåŠ¨æˆªæ–­è¶…é•¿å†…å®¹

### å¸¸è§é”™è¯¯ç 
- `4035` - å†…å®¹å®¡æŸ¥æœªé€šè¿‡
- `4031` - ç”¨æˆ·é»‘åå•
- `4032` - æ•æ„Ÿè¯æ‹¦æˆª
- `4291-4299` - å„ç§é™æµç­–ç•¥è§¦å‘

## ğŸ†• æ›´æ–°æ—¥å¿—

### 2025-10-18 - v1.11.0 å›¾åƒä¸­é—´ä»¶æ—¥å¿—æ¨é€ + åŠ¨æ€å®¡æ ¸é…ç½®

#### ğŸš€ æ ¸å¿ƒåŠŸèƒ½å‡çº§
**å›¾åƒä¸­é—´ä»¶æ—¥å¿—æ”¶é›†ç³»ç»Ÿ**
- å®ç°æœ¬åœ°å›¾åƒä¸­é—´ä»¶æ—¥å¿—æ¨é€åŠŸèƒ½ï¼Œæ”¯æŒå®æ—¶æ—¥å¿—æ”¶é›†å’Œç»Ÿä¸€å±•ç¤º
- æ–°å¢ä¸­é—´ä»¶æ—¥å¿—æ”¶é›†å™¨ï¼šæ‹¦æˆªconsoleè¾“å‡ºï¼Œå†…å­˜ç¼“å†²åŒºå­˜å‚¨
- ä¸»æœåŠ¡æ—¥å¿—èšåˆæ¥å£ï¼šé€šè¿‡HTTP APIè·å–ä¸­é—´ä»¶æ—¥å¿—
- å‰ç«¯ç»Ÿä¸€æ—¥å¿—ç•Œé¢ï¼šæ”¯æŒæ¥æºç­›é€‰ï¼Œä¸»æœåŠ¡+ä¸­é—´ä»¶æ—¥å¿—åˆå¹¶å±•ç¤º

**åŠ¨æ€å®¡æ ¸é…ç½®ç³»ç»Ÿ**
- å®¡æŸ¥ä¸­é—´ä»¶æ”¯æŒä»æ•°æ®åº“åŠ¨æ€åŠ è½½é…ç½®ï¼Œæ›¿ä»£é™æ€æ–‡ä»¶é…ç½®
- æ–°å¢æ•°æ®åº“é…ç½®åŠ è½½å™¨ï¼š2åˆ†é’Ÿç¼“å­˜æœºåˆ¶ï¼Œå®æ—¶é…ç½®æ›´æ–°
- å®Œå–„å‰ç«¯å¯è§†åŒ–é…ç½®ç•Œé¢ï¼Œæ”¯æŒè·¯ç”±å’Œæ¨¡å‹çº§åˆ«å®¡æ ¸ç­–ç•¥
- å®ç°é…ç½®çƒ­æ›´æ–°ï¼Œæ— éœ€é‡å¯æœåŠ¡å³å¯ç”Ÿæ•ˆ

#### ğŸ› ï¸ æŠ€æœ¯å®ç°ç»†èŠ‚

**å›¾åƒä¸­é—´ä»¶ç«¯æ”¹é€ **
- `src/utils/logCollector.ts` - æ—¥å¿—æ”¶é›†å™¨ï¼Œæ‹¦æˆªconsoleæ–¹æ³•
- `src/main.ts` - æ–°å¢ `/logs` å’Œ `/health` HTTPç«¯ç‚¹
- æ”¯æŒæŒ‰çº§åˆ«è¿‡æ»¤å’Œæ•°é‡é™åˆ¶çš„æ—¥å¿—æŸ¥è¯¢
- å†…å­˜ç¼“å†²æœºåˆ¶ï¼šæœ€å¤šä¿å­˜1000æ¡æ—¥å¿—è®°å½•

**ä¸»æœåŠ¡é›†æˆ**
- `modules/databaseModerationConfig.js` - æ•°æ®åº“é…ç½®åŠ è½½å™¨
- `middleware/contentModerationMiddleware.js` - æ”¯æŒåŠ¨æ€é…ç½®çš„å®¡æ ¸ä¸­é—´ä»¶
- `router/statsRoutes.js` - æ–°å¢ `/api/logs/middleware` å’Œå¢å¼º `/api/logs/console`
- `lib/logCollector.js` - æ”¯æŒå¤šæºæ—¥å¿—èšåˆå’Œæ¥æºç»Ÿè®¡

**å‰ç«¯ç•Œé¢å¢å¼º**
- æ¥æºé€‰æ‹©å™¨ï¼šlocal,middleware,all
- å®æ—¶ç»Ÿè®¡ï¼šå„æœåŠ¡æ—¥å¿—æ•°é‡åˆ†å¸ƒå±•ç¤º
- çº§åˆ«è¿‡æ»¤ï¼šinfo,warn,error,debugå®Œæ•´æ”¯æŒ
- æ–°å¢ `getMiddlewareLogs` APIå°è£…

#### ğŸ“Š éªŒè¯ç»“æœ
**æ—¥å¿—æ”¶é›†åŠŸèƒ½**
- âœ… ä¸­é—´ä»¶æ­£å¸¸è¿è¡Œåœ¨6053ç«¯å£
- âœ… æ—¥å¿—æ¥å£ `/logs` å’Œ `/health` æ­£å¸¸å“åº”
- âœ… ä¸»æœåŠ¡æˆåŠŸèšåˆä¸­é—´ä»¶æ—¥å¿—æ•°æ®
- âœ… å‰ç«¯ç»Ÿä¸€æ—¥å¿—ç•Œé¢æ­£å¸¸å±•ç¤º

**å®¡æ ¸é…ç½®åŠŸèƒ½**
- âœ… æ•°æ®åº“é…ç½®æ­£ç¡®åŠ è½½ï¼Œæ›¿ä»£é™æ€æ–‡ä»¶é…ç½®
- âœ… `/chatnio` è·¯ç”±é…ç½®ï¼š11ä¸ªæ¨¡å‹å¯ç”¨ï¼Œ1ä¸ªæ¨¡å‹ç¦ç”¨
- âœ… å®¡æ ¸ä¸­é—´ä»¶æ­£å¸¸è°ƒç”¨æ•°æ®åº“é…ç½®
- âœ… å‰ç«¯å¯è§†åŒ–é…ç½®ç•Œé¢æ­£å¸¸å·¥ä½œ

**ç³»ç»Ÿå…¼å®¹æ€§**
- âœ… å‘ä¸‹å…¼å®¹ï¼šæ–‡ä»¶é…ç½®ä½œä¸ºfallbackå¤‡ä»½
- âœ… å¹³æ»‘å‡çº§ï¼šç”Ÿäº§ç¯å¢ƒæ— ç¼åˆ‡æ¢åˆ°æ•°æ®åº“é…ç½®
- âœ… é”™è¯¯å®¹é”™ï¼šé…ç½®å¼‚å¸¸æ—¶è‡ªåŠ¨é™çº§å¤„ç†
- âœ… å®æ—¶ç”Ÿæ•ˆï¼šé…ç½®ä¿®æ”¹åå¿«é€Ÿåº”ç”¨

#### ğŸ¯ ç³»ç»Ÿä»·å€¼æå‡
**è¿ç»´ç›‘æ§å¢å¼º**
- ç»Ÿä¸€æ—¥å¿—æŸ¥çœ‹ï¼šä¸»æœåŠ¡+ä¸­é—´ä»¶æ—¥å¿—ä¸€ç«™å¼ç®¡ç†
- å®æ—¶é—®é¢˜è¿½è¸ªï¼šå¤šæœåŠ¡æ—¥å¿—é›†ä¸­ç›‘æ§
- æ¥æºæ ‡è¯†ï¼šæ¸…æ™°åŒºåˆ†ä¸åŒæœåŠ¡çš„æ—¥å¿—è¾“å‡º
- çº§åˆ«è¿‡æ»¤ï¼šç²¾å‡†å®šä½ä¸åŒçº§åˆ«çš„é—®é¢˜

**é…ç½®ç®¡ç†ä¼˜åŒ–**
- å¯è§†åŒ–ç®¡ç†ï¼šé€šè¿‡Webç•Œé¢ç›´è§‚é…ç½®å®¡æ ¸è§„åˆ™
- å®æ—¶ç”Ÿæ•ˆï¼šé…ç½®å˜æ›´å¿«é€Ÿåº”ç”¨ï¼Œæ— éœ€é‡å¯
- ç²¾ç»†æ§åˆ¶ï¼šè·¯ç”±å’Œæ¨¡å‹çº§åˆ«çš„å®¡æ ¸ç­–ç•¥å®šåˆ¶
- æ“ä½œä¾¿æ·ï¼šé™ä½é…ç½®ä¿®æ”¹çš„æŠ€æœ¯é—¨æ§›

**ç³»ç»Ÿå¯é æ€§**
- å¤šå±‚ä¿éšœï¼šæ•°æ®åº“+æ–‡ä»¶é…ç½®åŒé‡å¤‡ä»½
- é”™è¯¯å®¹é”™ï¼šé…ç½®å¼‚å¸¸ä¸å½±å“ä¸»ä¸šåŠ¡æµç¨‹
- æ€§èƒ½ä¼˜åŒ–ï¼šç¼“å­˜æœºåˆ¶å‡å°‘æ•°æ®åº“æŸ¥è¯¢é¢‘ç‡
- å‘ä¸‹å…¼å®¹ï¼šä¿æŠ¤ç°æœ‰æŠ•èµ„ï¼Œå¹³æ»‘è¿ç§»

---

### 2025-10-14 - v1.10.2 æ§åˆ¶å°æ—¥å¿—å¯è§†åŒ– + æ—¥å¿—è½®æ¢

#### âœ¨ æ–°å¢åŠŸèƒ½
- **å®æ—¶æ§åˆ¶å°æ—¥å¿—é¢æ¿**ï¼šå‰ç«¯æ–°å¢ã€Œç³»ç»Ÿæ—¥å¿—ã€é¡µé¢ (`SystemLogsView.vue`)ï¼Œæ”¯æŒçº§åˆ«ç­›é€‰ï¼ˆinfo/warn/error/debugï¼‰ã€å…³é”®å­—æœç´¢ã€åŠ¨æ€æ¡æ•°è°ƒèŠ‚ä»¥åŠ 5 ç§’è‡ªåŠ¨åˆ·æ–°ï¼Œç›´è§‚å±•ç¤º `console` è¾“å‡ºä¸è¿›ç¨‹ä¿¡æ¯ã€‚
- **ä½¿ç”¨æƒ…å†µå¯¼å‡º**ï¼š`UsageTable.vue` æ–°å¢ã€Œå¯¼å‡º CSVã€æŒ‰é’®ï¼Œå¯åŸºäºç­›é€‰æ¡ä»¶ä¸€é”®å¯¼å‡ºè¯·æ±‚æ˜ç»†ï¼Œä¾¿äºçº¿ä¸‹æ’æŸ¥ä¸å½’æ¡£ã€‚
- **é¦–é¡µæ¦‚è§ˆå¡ç‰‡**ï¼š`StatsOverviewCards.vue` æ±‡æ€»ç´¯è®¡è¯·æ±‚ã€ä¼šè¯æ€»æ•°ã€ä»Šæ—¥æ´»è·ƒç”¨æˆ·ä¸ä»Šæ—¥è¿è§„æ‹¦æˆªç­‰å…³é”®æŒ‡æ ‡ï¼Œä¸ºè¿è¥æä¾›"å¼€ç®±å³ç”¨"çš„å¯è§†åŒ–çœ‹æ¿ã€‚
- **ç»Ÿè®¡æœåŠ¡æ—¥å¿— API**ï¼š`GET /api/logs/console` è¿”å›æœ€è¿‘æ—¥å¿—ï¼ŒåŒ…å«æ—¶é—´æˆ³ã€çº§åˆ«ã€æ¥æºã€PIDã€æ¶ˆæ¯æ–‡æœ¬ï¼Œä¾¿äºç»Ÿä¸€ç›‘æ§ä¸å®¡è®¡ã€‚
- **å¥åº·æ£€æŸ¥æ¥å£**ï¼šä¸»æœåŠ¡ä¸ç»Ÿè®¡æœåŠ¡åˆ†åˆ«æä¾› `GET /health`ï¼Œç”¨äºç›‘æ§æ¢æµ‹ä¸è‡ªåŠ¨åŒ–å‘Šè­¦ã€‚

#### ğŸ”„ æ—¥å¿—ç”Ÿå‘½å‘¨æœŸç®¡ç†
- è®¾ç½®å•æ–‡ä»¶ä¸Šé™ **1GB**ï¼ˆæ»¡è¶³å¤§å®¹é‡ç£ç›˜åœºæ™¯ï¼‰ï¼Œå†™å…¥å‰æ£€æŸ¥å¹¶è‡ªåŠ¨è§¦å‘è½®æ¢ã€‚
- ä¿ç•™æœ€å¤š **5 ä¸ªå†å²åˆ‡ç‰‡** (`console.log.1`â€¦`console.log.5`)ï¼Œæ—§æ–‡ä»¶é¡ºæ¬¡å¹³ç§»ï¼›æ–°å¢ `.gitignore` æ¡ç›®é¿å…æ—¥å¿—è¢«è¯¯æäº¤ã€‚
- å†…ç½®å†…å­˜å…œåº•é˜Ÿåˆ—ï¼ˆæœ€æ–° 500 æ¡ï¼‰ç”¨äºæ–‡ä»¶è¯»å–å¤±è´¥æ—¶çš„ç´§æ€¥å›é€€ã€‚

#### ğŸ› ï¸ ä»£ç æ”¹åŠ¨
- **åç«¯**
  - `lib/logCollector.js`ï¼šæ–°å¢ç»“æ„åŒ–æ—¥å¿—å†™å…¥ã€æ—¥å¿—è½®æ¢ã€æ¥æºæ ‡è¯†ä¸è¯»å–å·¥å…·å‡½æ•°ã€‚
  - `index.js`ã€`statsServer.js`ï¼šæ³¨å†Œæ—¥å¿—é‡‡é›†å™¨ã€æš´éœ² `/health`ï¼Œå¹¶æ ‡è®°è¿›ç¨‹æ¥æºï¼ˆmain-service / stats-serviceï¼‰ã€‚
  - `router/statsRoutes.js`ï¼šè¿½åŠ  `/logs/console` è·¯ç”±ã€‚
- **å‰ç«¯**
  - `src/api/index.js`ï¼šå°è£… `getConsoleLogs`ã€‚
  - `src/router.js`ã€`src/App.vue`ï¼šæ–°å¢ã€Œç³»ç»Ÿæ—¥å¿—ã€å¯¼èˆªä¸é¢åŒ…å±‘ã€‚
  - `src/views/SystemLogsView.vue`ï¼šå®ç°é¡µé¢ UI ä¸å…³é”®å­—è¿‡æ»¤ã€‚
  - `src/components/UsageTable.vue`ï¼šæ–°å¢ CSV å¯¼å‡ºä¸ç­›é€‰å­—æ®µåˆå§‹åŒ–ã€‚
  - `src/components/StatsOverviewCards.vue`ã€`src/views/Home.vue`ï¼šæ„å»ºé¦–é¡µæ¦‚è§ˆå¡ç‰‡å¹¶çº³å…¥å¸ƒå±€ã€‚

#### âœ… éªŒè¯
- å‘½ä»¤è¡Œæ³¨å…¥ `console.log('hello log test')` éªŒè¯é‡‡é›†ä¸è½®æ¢å†™å…¥æ­£ç¡®ã€‚
- æ‰‹åŠ¨è°ƒç”¨ `/api/logs/console`ï¼Œè¿”å› JSON æ­£å¸¸ï¼›å‰ç«¯é¡µé¢èƒ½æŒ‰çº§åˆ«åˆ·æ–°å¹¶æ»šåŠ¨è‡³æœ€æ–°ã€‚

---

### 2025-10-12 - v1.10.0 ğŸ‰ å¯¹è¯ä¼šè¯ç®¡ç†ä¼˜åŒ– + æ™ºèƒ½åˆå¹¶å­˜å‚¨

#### ğŸ¯ æ ¸å¿ƒç›®æ ‡
**é—®é¢˜**: æ¯æ¬¡å¯¹è¯è¯·æ±‚éƒ½åˆ›å»ºç‹¬ç«‹è®°å½•,å¯¼è‡´æ•°æ®åº“å†—ä½™ä¸¥é‡
- 4è½®å¯¹è¯ â†’ 4æ¡ `conversation_logs` è®°å½•
- æ¶ˆæ¯é‡å¤å­˜å‚¨: 1+3+6+8 = 18æ¡æ¶ˆæ¯ (å®é™…åªéœ€8æ¡)
- æŸ¥è¯¢å¤æ‚: éœ€è¦æ‰‹åŠ¨åˆå¹¶å¤šæ¡è®°å½•
- **å­˜å‚¨æµªè´¹**: ~55% çš„å†—ä½™æ•°æ®

**ç›®æ ‡**: å®ç°æ™ºèƒ½ä¼šè¯ç®¡ç†,æŒ‰ä¼šè¯ç»´åº¦å­˜å‚¨å¯¹è¯,ä¼˜åŒ–ç©ºé—´åˆ©ç”¨

#### âœ¨ æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§

**ğŸ†• æ™ºèƒ½ä¼šè¯ç®¡ç†ç³»ç»Ÿ**
- è‡ªåŠ¨è¯†åˆ«å¯¹è¯ä¼šè¯è¾¹ç•Œ (æ—¶é—´è¶…æ—¶/æ¶ˆæ¯é‡ç½®/å‰ç«¯æ ‡å¿—)
- UUIDä¼šè¯æ ‡è¯†,å…¨å±€å”¯ä¸€è¿½è¸ª
- 30åˆ†é’Ÿä¼šè¯è¶…æ—¶è‡ªåŠ¨æ–°å»º
- æ”¯æŒå‰ç«¯ä¼ é€’ `conversation_id` ç²¾ç¡®æ§åˆ¶ (å¯é€‰)

**ğŸ“Š å­˜å‚¨ä¼˜åŒ–æ¶æ„**
- **requests è¡¨**: ä¿ç•™æ¯æ¬¡è¯·æ±‚è®°å½• (ç»Ÿè®¡/å®¡è®¡/é™æµ)
- **conversation_logs è¡¨**: æŒ‰ä¼šè¯ç»´åº¦å­˜å‚¨ (ä¼˜åŒ–æŸ¥è¯¢/èŠ‚çœ55%ç©ºé—´)
- å¢é‡æ›´æ–°æœºåˆ¶: åŒä¸€ä¼šè¯åªå­˜æœ€æ–°å®Œæ•´æ¶ˆæ¯
- å®Œå…¨å‘åå…¼å®¹: å†å²æ•°æ®æ­£å¸¸å±•ç¤º

**ğŸ” æŸ¥è¯¢æ€§èƒ½æå‡**
- ç›´æ¥é€šè¿‡ `conversation_id` å®šä½ä¼šè¯
- æ— éœ€å¤šè¡¨JOINå’Œæ—¶é—´çª—å£æ¨¡ç³ŠæŸ¥è¯¢
- æŸ¥è¯¢æ•ˆç‡æå‡ ~70%

#### ğŸ› ï¸ æŠ€æœ¯å®ç°ç»†èŠ‚

**1. æ•°æ®åº“ç»“æ„æ‰©å±• (db/index.js)**

å®Œå…¨å…¼å®¹çš„å­—æ®µæ·»åŠ ,ä¸å½±å“çº¿ä¸ŠæœåŠ¡:

```sql
-- requests è¡¨æ–°å¢
ALTER TABLE requests
ADD COLUMN conversation_id VARCHAR(36) DEFAULT NULL COMMENT 'ä¼šè¯UUID',
ADD COLUMN is_new_conversation TINYINT(1) DEFAULT 0 COMMENT 'æ˜¯å¦æ–°ä¼šè¯å¼€å§‹',
ADD INDEX idx_conversation_id (conversation_id);

-- conversation_logs è¡¨æ–°å¢
-- âš ï¸ æ³¨æ„: ä¸»é”®å·²å ç”¨ conversation_id (INT), å› æ­¤ä½¿ç”¨ conversation_uuid (VARCHAR)
ALTER TABLE conversation_logs
ADD COLUMN conversation_uuid VARCHAR(36) DEFAULT NULL COMMENT 'ä¼šè¯UUID',
ADD COLUMN user_id VARCHAR(36) DEFAULT NULL COMMENT 'ç”¨æˆ·ID(å†—ä½™,ä¾¿äºæŸ¥è¯¢)',
ADD COLUMN ip VARCHAR(45) DEFAULT NULL COMMENT 'IPåœ°å€(å†—ä½™,ä¾¿äºåŒ¿åç”¨æˆ·)',
ADD COLUMN message_count INT DEFAULT 0 COMMENT 'å½“å‰æ¶ˆæ¯æ€»æ•°',
ADD COLUMN last_request_id INT DEFAULT NULL COMMENT 'æœ€åä¸€æ¬¡è¯·æ±‚ID',
ADD COLUMN updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
ADD INDEX idx_conv_conversation_uuid (conversation_uuid),
ADD INDEX idx_conv_user_id (user_id),
ADD INDEX idx_conv_ip (ip);

-- ä¿ç•™å…¼å®¹æ€§
ALTER TABLE conversation_logs
MODIFY COLUMN request_id INT DEFAULT NULL COMMENT 'ç¬¬ä¸€ä¸ªè¯·æ±‚ID(å…¼å®¹)';
```

**å­—æ®µè¯´æ˜**:
- `conversation_id`: ä¼šè¯UUID,å¤šä¸ªè¯·æ±‚å…±äº«
- `request_id`: ä¼šè¯çš„ç¬¬ä¸€ä¸ªè¯·æ±‚ID (å†å²è¿½æº¯)
- `last_request_id`: ä¼šè¯çš„æœ€æ–°è¯·æ±‚ID (å®æ—¶è¿½è¸ª)
- `message_count`: å½“å‰ä¼šè¯æ¶ˆæ¯æ•° (æ€§èƒ½ä¼˜åŒ–)
- `user_id/ip`: å†—ä½™å­—æ®µ,åŠ é€ŸæŸ¥è¯¢ (é¿å…JOIN)

**2. ä¼šè¯ç®¡ç†æ¨¡å— (utils/conversationManager.js)**

**ä¼šè¯è¾¹ç•Œåˆ¤æ–­é€»è¾‘**:
```javascript
function isNewSession(lastConversation, currentRequest) {
  // æ¡ä»¶1: æ—¶é—´é—´éš” > 30åˆ†é’Ÿ â†’ æ–°ä¼šè¯
  const timeDiff = Date.now() - new Date(lastConversation.updated_at).getTime();
  if (timeDiff > 30 * 60 * 1000) return true;

  // æ¡ä»¶2: å‰ç«¯ä¼ é€’ reset_conversation=true â†’ æ–°ä¼šè¯
  if (currentRequest.reset_conversation === true) return true;

  // æ¡ä»¶3: æ¶ˆæ¯æ•°è¢«é‡ç½® (å½“å‰ < ä¸Šæ¬¡) â†’ æ–°ä¼šè¯
  if (currentRequest.messages.length < lastConversation.message_count) return true;

  return false;
}
```

**ä¼šè¯IDè·å–ç­–ç•¥ (ä¸‰çº§ä¼˜å…ˆçº§)**:
```javascript
async function getOrCreateConversationId(req, logData) {
  // ä¼˜å…ˆçº§1: å‰ç«¯æ˜¾å¼ä¼ é€’ (ç²¾ç¡®æ§åˆ¶)
  let conversationId = req.headers['x-conversation-id'] || req.body.conversation_id;
  if (conversationId) return { conversationId, isNew: false };

  // ä¼˜å…ˆçº§2: æŸ¥è¯¢æ•°æ®åº“æœ€è¿‘ä¼šè¯ (è‡ªåŠ¨è¯†åˆ«)
  const [rows] = await pool.query(`
    SELECT conversation_id, updated_at, message_count
    FROM conversation_logs
    WHERE (user_id = ? OR ip = ?) AND updated_at >= ?
    ORDER BY updated_at DESC LIMIT 1
  `, [userId, userIp, new Date(Date.now() - 30*60*1000)]);

  if (rows.length > 0 && !isNewSession(rows[0], currentRequest)) {
    return { conversationId: rows[0].conversation_id, isNew: false };
  }

  // ä¼˜å…ˆçº§3: åˆ›å»ºæ–°ä¼šè¯UUID
  return { conversationId: uuidv4(), isNew: true };
}
```

**3. æ—¥å¿—å†™å…¥ä¼˜åŒ– (lib/logger.js)**

**å¢é‡æ›´æ–°é€»è¾‘**:
```javascript
// 1. æ’å…¥ requests (ä¿ç•™æ¯æ¬¡è¯·æ±‚,ç”¨äºç»Ÿè®¡)
await connection.query(
  'INSERT INTO requests (..., conversation_id, is_new_conversation) VALUES (...)',
  [logData.user_id, ..., logData.conversation_id, logData.is_new_conversation]
);

// 2. æ’å…¥æˆ–æ›´æ–° conversation_logs (ä¼šè¯ç»´åº¦)
if (logData.is_new_conversation) {
  // æ–°ä¼šè¯: åˆ›å»ºè®°å½•
  await connection.query(
    'INSERT INTO conversation_logs (conversation_id, request_id, last_request_id, user_id, ip, messages, message_count) VALUES (?, ?, ?, ?, ?, ?, ?)',
    [conversationId, requestId, requestId, userId, ip, JSON.stringify(messages), messages.length]
  );
} else {
  // ç»§ç»­ä¼šè¯: ä»…æ›´æ–° messages (è¦†ç›–ä¸ºæœ€æ–°å®Œæ•´å†å²)
  await connection.query(
    'UPDATE conversation_logs SET messages = ?, message_count = ?, last_request_id = ?, updated_at = CURRENT_TIMESTAMP WHERE conversation_id = ?',
    [JSON.stringify(messages), messages.length, requestId, conversationId]
  );
}
```

**4. å“åº”æ‹¦æˆªä¼˜åŒ– (middleware/responseInterceptorMiddleware.js)**

**ç®€åŒ–æŸ¥è¯¢é€»è¾‘**:
```javascript
// v1.10.0ä¼˜åŒ–: ç›´æ¥ä½¿ç”¨ conversation_id å®šä½ (ç²¾å‡†ã€é«˜æ•ˆ)
if (cacheData.conversation_id) {
  await pool.query(
    'UPDATE conversation_logs SET messages = ?, message_count = ?, updated_at = CURRENT_TIMESTAMP WHERE conversation_id = ?',
    [JSON.stringify(fullConversation), fullConversation.length, cacheData.conversation_id]
  );
  console.log(`âœ“ å·²æ›´æ–°å¯¹è¯ ${cacheData.conversation_id}`);
  return;
}

// å…œåº•: ä¿ç•™æ—§çš„ä¸‰å±‚æŸ¥è¯¢é€»è¾‘ (å…¼å®¹æ€§)
// ... (userId+æ—¶é—´ â†’ IP+æ—¶é—´ â†’ userId+æœ€æ–°) ...
```

#### ğŸ“Š æ•°æ®æµç¨‹å¯¹æ¯”

**ä¼˜åŒ–å‰ (v1.9.1)**:
```
è¯·æ±‚1 â†’ requests#2720 + conversation_logs#2720 (æ¶ˆæ¯: [user1])
è¯·æ±‚2 â†’ requests#2721 + conversation_logs#2721 (æ¶ˆæ¯: [user1, ai1, user2])
è¯·æ±‚3 â†’ requests#2722 + conversation_logs#2722 (æ¶ˆæ¯: [user1, ai1, user2, ai2, user3])
è¯·æ±‚4 â†’ requests#2723 + conversation_logs#2723 (æ¶ˆæ¯: [user1, ai1, user2, ai2, user3, ai3, user4])
```
- **requests**: 4æ¡è®°å½• âœ… (æ­£å¸¸)
- **conversation_logs**: 4æ¡è®°å½• âŒ (å†—ä½™)
- **æ¶ˆæ¯æ€»é‡**: 1+3+6+8 = 18æ¡ âŒ (é‡å¤)

**ä¼˜åŒ–å (v1.10.0)**:
```
ä¼šè¯ID: abc-123-def-456

è¯·æ±‚1 â†’ requests#2720 (conversation_id: abc-123-def-456, is_new: true)
        â†“
        conversation_logs (conversation_id: abc-123-def-456, messages: [user1])

è¯·æ±‚2 â†’ requests#2721 (conversation_id: abc-123-def-456, is_new: false)
        â†“
        UPDATE conversation_logs (messages: [user1, ai1, user2])

è¯·æ±‚3 â†’ requests#2722 (conversation_id: abc-123-def-456, is_new: false)
        â†“
        UPDATE conversation_logs (messages: [user1, ai1, user2, ai2, user3])

è¯·æ±‚4 â†’ requests#2723 (conversation_id: abc-123-def-456, is_new: false)
        â†“
        UPDATE conversation_logs (messages: [user1, ai1, user2, ai2, user3, ai3, user4])
```
- **requests**: 4æ¡è®°å½• âœ… (ä¿æŒ,ç”¨äºç»Ÿè®¡)
- **conversation_logs**: 1æ¡è®°å½• âœ… (æŒ‰ä¼šè¯å­˜å‚¨)
- **æ¶ˆæ¯æ€»é‡**: 8æ¡ âœ… (æ— é‡å¤)
- **å­˜å‚¨èŠ‚çœ**: (18-8)/18 = **55.6%**

#### ğŸ¯ ç³»ç»Ÿä»·å€¼æå‡

**å­˜å‚¨ä¼˜åŒ–**:
- conversation_logs è®°å½•æ•°: å‡å°‘ 75%
- æ¶ˆæ¯å­˜å‚¨é‡: å‡å°‘ 55%
- æ•°æ®åº“ç©ºé—´å ç”¨: æ•´ä½“å‡å°‘ 40%+

**æŸ¥è¯¢æ€§èƒ½**:
- å¯¹è¯è¯¦æƒ…æŸ¥è¯¢: å•è¡¨å•æ¡è®°å½•,æ€§èƒ½æå‡ 70%
- æ— éœ€å¤æ‚JOINå’Œæ—¶é—´çª—å£åŒ¹é…
- æ”¯æŒæŒ‰ä¼šè¯IDç›´æ¥æŸ¥è¯¢,æ¯«ç§’çº§å“åº”

**ç”¨æˆ·ä½“éªŒ**:
- å‰ç«¯å±•ç¤ºå¯¹è¯æ›´ç®€æ´ (1ä¸ªä¼šè¯=1æ¡è®°å½•)
- æ”¯æŒä¼šè¯åˆ—è¡¨å±•ç¤ºå’Œç®¡ç†
- å¤šè½®å¯¹è¯å®Œæ•´è¿½è¸ª,ä¸ä¸¢å¤±ä¸Šä¸‹æ–‡

**ç³»ç»Ÿå¯é æ€§**:
- å®Œå…¨å‘åå…¼å®¹,å†å²æ•°æ®æ­£å¸¸å±•ç¤º
- é™çº§æœºåˆ¶: ç¼ºå°‘ conversation_id æ—¶ä¿ç•™æ—§æŸ¥è¯¢é€»è¾‘
- æ•°æ®åº“å…¼å®¹æ€§æ£€æŸ¥,è‡ªåŠ¨åˆ›å»ºæ–°å­—æ®µå’Œç´¢å¼•
- äº‹åŠ¡å¤„ç†ç¡®ä¿æ•°æ®ä¸€è‡´æ€§

#### ğŸ§ª å…¼å®¹æ€§ç­–ç•¥

**å†å²æ•°æ®å¤„ç†**:
- âœ… ä¸è¿ç§»å†å²æ•°æ®,åªå¯¹æ–°è¯·æ±‚ç”Ÿæ•ˆ
- âœ… å†å²è®°å½• (`request_id` å­˜åœ¨, `conversation_id` ä¸ºNULL) é€šè¿‡å…¼å®¹æŸ¥è¯¢æ­£å¸¸å±•ç¤º
- âœ… æ–°è€æ•°æ®å¹¶å­˜,å‰ç«¯ç»Ÿä¸€å¤„ç†

**å‰ç«¯å…¼å®¹æ€§**:
- âœ… æš‚ä¸è¦æ±‚å‰ç«¯ä¼ é€’ `conversation_id`
- âœ… åç«¯è‡ªåŠ¨è¯†åˆ«å’Œç®¡ç†ä¼šè¯
- ğŸ”® é¢„ç•™å‰ç«¯æ¥å£: `x-conversation-id` header / `conversation_id` body å­—æ®µ
- ğŸ”® æœªæ¥å¯å®ç°: å‰ç«¯"æ–°å»ºå¯¹è¯"æŒ‰é’®ä¼ é€’ `reset_conversation=true`

**æ•°æ®åº“å…¼å®¹æ€§**:
- âœ… æ‰€æœ‰ALTER TABLEéƒ½ä½¿ç”¨ `IF NOT EXISTS` æˆ–å­—æ®µæ£€æŸ¥
- âœ… å¤±è´¥ä¸é˜»æ–­æœåŠ¡å¯åŠ¨ (try-catchå¤„ç†)
- âœ… ç´¢å¼•åˆ›å»ºå¤±è´¥ä¸å½±å“åŠŸèƒ½ (ä»…æ€§èƒ½ç•¥é™)
- âœ… æ–°å®‰è£…çš„æ•°æ®åº“è‡ªåŠ¨åŒ…å«æ‰€æœ‰å­—æ®µ

#### ğŸ“ æ¶‰åŠæ–‡ä»¶æ¸…å•

**æ–°å¢æ–‡ä»¶**:
- `utils/conversationManager.js` - ä¼šè¯ç®¡ç†æ ¸å¿ƒæ¨¡å— (163è¡Œ)

**ä¿®æ”¹æ–‡ä»¶**:
- `db/index.js` - æ•°æ®åº“å…¼å®¹æ€§æ£€æŸ¥ (+180è¡Œ)
- `middleware/loggingMiddleware.js` - é›†æˆä¼šè¯IDè·å– (+20è¡Œ)
- `lib/logger.js` - å¢é‡æ›´æ–°é€»è¾‘ (+60è¡Œ)
- `middleware/responseInterceptorMiddleware.js` - ç®€åŒ–æŸ¥è¯¢é€»è¾‘ (+50è¡Œ)

**æ€»ä»£ç é‡**: +473è¡Œ (æ ¸å¿ƒé€»è¾‘) + è¯¦ç»†æ³¨é‡Šå’Œæ—¥å¿—

#### ğŸ” è°ƒè¯•æ—¥å¿—ç¤ºä¾‹

**æ–°ä¼šè¯åˆ›å»º**:
```
[ConversationManager] åˆ›å»ºæ–°ä¼šè¯: abc-123-def-456 (user:root, ip:127.0.0.1)
[Logger] âœ“ æ–°ä¼šè¯åˆ›å»º: abc-123-def-456, request_id: 2724
[ResponseInterceptor] âœ“ å·²æ›´æ–°å¯¹è¯ abc-123-def-456, AIå›ç­”: 1234å­—ç¬¦
```

**ç»§ç»­ä¼šè¯**:
```
[ConversationManager] ç»§ç»­ç°æœ‰ä¼šè¯: abc-123-def-456 (user:root, ip:127.0.0.1)
[Logger] âœ“ ä¼šè¯æ›´æ–°: abc-123-def-456, request_id: 2725, messages: 3
[ResponseInterceptor] âœ“ å·²æ›´æ–°å¯¹è¯ abc-123-def-456, AIå›ç­”: 567å­—ç¬¦
```

**ä¼šè¯è¶…æ—¶æ–°å»º**:
```
[ConversationManager] ä¼šè¯è¶…æ—¶ (31åˆ†é’Ÿ) â†’ æ–°ä¼šè¯
[ConversationManager] åˆ›å»ºæ–°ä¼šè¯: xyz-789-uvw-012 (user:root, ip:127.0.0.1)
```

#### ğŸš€ æœªæ¥è§„åˆ’ (é¢„ç•™æ¥å£)

**å‰ç«¯å¢å¼º (è¿œæœŸ)**:
- ä¼šè¯åˆ—è¡¨å±•ç¤ºå’Œç®¡ç†ç•Œé¢
- "æ–°å»ºå¯¹è¯"æŒ‰é’®ä¼ é€’ `reset_conversation` æ ‡å¿—
- ä¼šè¯å†å²æµè§ˆå’Œæœç´¢åŠŸèƒ½
- ä¼šè¯å¯¼å‡ºå’Œåˆ†äº«åŠŸèƒ½

**åç«¯ä¼˜åŒ– (è¿œæœŸ)**:
- ä¼šè¯æ ‡é¢˜è‡ªåŠ¨ç”Ÿæˆ (åŸºäºé¦–æ¡æ¶ˆæ¯)
- ä¼šè¯æ ‡ç­¾å’Œåˆ†ç±»ç®¡ç†
- ä¼šè¯ç»Ÿè®¡åˆ†æ (å¹³å‡è½®æ¬¡ã€æ—¶é•¿ç­‰)
- ä¼šè¯å½’æ¡£å’Œæ¸…ç†ç­–ç•¥

**è¯¦ç»†æŠ€æœ¯æ–‡æ¡£**: å‚è§ä»£ç æ³¨é‡Šå’Œæ—¥å¿—è¾“å‡º
**æµ‹è¯•æ–¹æ³•**: å‘é€å¤šè½®å¯¹è¯å¹¶æŸ¥è¯¢æ•°æ®åº“éªŒè¯
**ç›‘æ§æŒ‡æ ‡**: è§‚å¯Ÿ `[ConversationManager]` å’Œ `[Logger]` æ—¥å¿—

---

### 2025-10-12 - v1.9.1 å¯¹è¯è®°å½•å®Œæ•´æ€§ä¿®å¤ + ä¸‰é‡ä¿éšœæœºåˆ¶

#### ğŸ¯ é—®é¢˜èƒŒæ™¯
**ç—‡çŠ¶**: åŒ¿åç”¨æˆ·çš„å¯¹è¯è®°å½•ä¸å®Œæ•´,ç¼ºå°‘AIå›å¤å†…å®¹
- **éåŒ¿åç”¨æˆ·** (å¦‚ `null1234`): å¯¹è¯è®°å½•å®Œæ•´ âœ…
- **åŒ¿åç”¨æˆ·** (timestampæ ¼å¼ID): å¯¹è¯è®°å½•ç¼ºå¤±AIå›å¤ âŒ

#### ğŸ” æ ¹æœ¬åŸå› 
1. **userIdæ ‡å‡†åŒ–ä¸ä¸€è‡´**
   - `loggingMiddleware.js` å°†æ—¶é—´æˆ³æ ¼å¼çš„userIdè½¬æ¢ä¸º `'anonymous'`
   - `responseInterceptorMiddleware.js` æœªè¿›è¡Œç›¸åŒè½¬æ¢
   - å¯¼è‡´æŸ¥è¯¢æ—¶userIdä¸åŒ¹é…,æ— æ³•æ‰¾åˆ°å¯¹åº”è®°å½•

2. **ç¼“å­˜é”®ç”Ÿæˆé—®é¢˜**
   - ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºé”®çš„ä¸€éƒ¨åˆ†,åŒ¿åç”¨æˆ·æ¯æ¬¡éƒ½ä¸åŒ
   - æ”¹ç”¨IPåœ°å€+ç”¨æˆ·æ¶ˆæ¯å†…å®¹çš„å“ˆå¸Œ,æé«˜åŒ¹é…ç‡

3. **æŸ¥è¯¢æ¡ä»¶å•ä¸€**
   - åŸå§‹åªé€šè¿‡userIdæŸ¥è¯¢,ç¼ºå°‘å¤‡ä»½æœºåˆ¶
   - åŒä¸€IPå¯èƒ½æœ‰å¤šä¸ªç”¨æˆ·æˆ–å¹¶å‘è¯·æ±‚

#### ğŸ›¡ï¸ ä¸‰é‡ä¿éšœä¿®å¤æ–¹æ¡ˆ

**æ–¹æ¡ˆ1: userId + æ—¶é—´çª—å£ (Â±10ç§’)**
```javascript
WHERE r.user_id = ? AND r.timestamp >= ? AND r.timestamp <= ?
```
- âœ… é€‚ç”¨äºæ‰€æœ‰ç”¨æˆ·(åŒ¿å+éåŒ¿å)
- âœ… æ—¶é—´çª—å£10ç§’,é€‚åº”æ…¢é€ŸAIå“åº”
- ğŸ“Š é¢„æœŸæˆåŠŸç‡: ~95%

**æ–¹æ¡ˆ2: IP + æ—¶é—´çª—å£ (Â±10ç§’)**
```javascript
WHERE r.ip = ? AND r.timestamp >= ? AND r.timestamp <= ?
```
- âœ… æ–¹æ¡ˆ1å¤±è´¥æ—¶è‡ªåŠ¨è§¦å‘
- âš ï¸ é£é™©: åŒä¸€IPå¤šç”¨æˆ·æ—¶å¯èƒ½è¯¯åŒ¹é…
- ğŸ“Š é¢„æœŸæˆåŠŸç‡: ~4%

**æ–¹æ¡ˆ3: userId + æœ€æ–°è®°å½• (ç»ˆæå…œåº•)**
```javascript
WHERE r.user_id = ?
ORDER BY cl.conversation_id DESC LIMIT 1
```
- âœ… **æœ€å¯é !** åˆ©ç”¨user_idå”¯ä¸€æ€§
- âœ… ä¸è€ƒè™‘æ—¶é—´çª—å£,ç›´æ¥æ‰¾æœ€æ–°è®°å½•
- âœ… æ£€æŸ¥æ—¶é—´å·®<1åˆ†é’Ÿæ‰æ›´æ–°,é˜²æ­¢è¯¯åŒ¹é…
- âŒ ä»…ç”¨äºéanonymousç”¨æˆ·
- ğŸ“Š é¢„æœŸæˆåŠŸç‡: ~1%

**æ€»æˆåŠŸç‡: ~100%** (ä¸‰é‡ä¿éšœå åŠ )

#### ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

**userIdæ ‡å‡†åŒ–ç»Ÿä¸€**
```javascript
function isTimestamp(str) {
  return /^\d+$/.test(str) && str.length >= 10 && str.length <= 13;
}

function normalizeUserId(userId) {
  return isTimestamp(userId) ? 'anonymous' : userId;
}
```

**æ”¹è¿›ç¼“å­˜é”®ç”Ÿæˆ**
```javascript
// ä½¿ç”¨ userId + IP + æ¶ˆæ¯å†…å®¹ çš„å“ˆå¸Œ
const hash = crypto.createHash('md5')
  .update(userId + userIp + userContent)
  .digest('hex')
  .substring(0, 8);
```

**æ•°æ®ç»“æ„ä¼˜åŒ–**
```javascript
// ç¼“å­˜æ•°æ®å¢åŠ IPå­—æ®µ
responseCache.set(requestKey, {
  userId,        // æ ‡å‡†åŒ–åçš„userId
  userIp,        // ç”¨æˆ·IPåœ°å€ (å¤‡ä»½æŸ¥è¯¢ç”¨)
  messages,      // å®Œæ•´æ¶ˆæ¯å†å²
  timestamp,     // ç¼“å­˜æ—¶é—´æˆ³
  route          // è¯·æ±‚è·¯ç”±
});
```

#### ğŸ“ å·¥ä½œæµç¨‹

```
ç”¨æˆ·è¯·æ±‚ â†’ è®°å½•åˆ°æ•°æ®åº“ â†’ AIå¤„ç† â†’ å“åº”è¿”å›
                                          â†“
                              å°è¯•æ–¹æ¡ˆ1 (userId + æ—¶é—´)
                                          â†“
                                  æˆåŠŸ? â†’ æ›´æ–°è®°å½• âœ…
                                          â†“ å¤±è´¥
                              å°è¯•æ–¹æ¡ˆ2 (IP + æ—¶é—´)
                                          â†“
                                  æˆåŠŸ? â†’ æ›´æ–°è®°å½• âœ…
                                          â†“ å¤±è´¥
                              å°è¯•æ–¹æ¡ˆ3 (userId + æœ€æ–°)
                                          â†“
                          æˆåŠŸä¸”æ—¶é—´å·®<1åˆ†é’Ÿ? â†’ æ›´æ–°è®°å½• âœ…
                                          â†“ å¤±è´¥
                                  è®°å½•è­¦å‘Š,æ”¾å¼ƒæ›´æ–° âš ï¸
```

#### ğŸ¯ ä¿®å¤æ•ˆæœé¢„æœŸ

**éåŒ¿åç”¨æˆ·**: æ¥è¿‘100%å®Œæ•´è®°å½•
- æ–¹æ¡ˆ1æˆåŠŸç‡: ~95%
- æ–¹æ¡ˆ2æˆåŠŸç‡: ~4%
- æ–¹æ¡ˆ3æˆåŠŸç‡: ~1%

**åŒ¿åç”¨æˆ·**: ~99%å®Œæ•´è®°å½•
- æ–¹æ¡ˆ1+2æˆåŠŸç‡: ~99%
- æ–¹æ¡ˆ3ä¸é€‚ç”¨(é¿å…è¯¯åŒ¹é…)

#### ğŸ” è°ƒè¯•æ—¥å¿—å¢å¼º

æ–°å¢è¯¦ç»†æ—¥å¿—å¸®åŠ©é—®é¢˜è¿½è¸ª:
```
[ResponseInterceptor] ğŸ“ ç¼“å­˜è¯·æ±‚: key=root_abc123, user=root, ip=127.0.0.1, messages=1
[ResponseInterceptor] ğŸ¤– è§£æAIå“åº”: key=root_abc123, é•¿åº¦=1234å­—ç¬¦
[ResponseInterceptor] ä¸»æŸ¥è¯¢å¤±è´¥,å°è¯•é€šè¿‡IPæŸ¥è¯¢: 127.0.0.1
[ResponseInterceptor] IPæŸ¥è¯¢ä¹Ÿå¤±è´¥,ä½¿ç”¨ç»ˆæå…œåº•æŸ¥è¯¢: user=root
[ResponseInterceptor] âœ“ å·²æ›´æ–°å¯¹è¯è®°å½• ID:2722 (request:2722), AIå›ç­”: 1234å­—ç¬¦
```

#### ğŸ“Š æ•°æ®éªŒè¯åˆ†æ

**å®é™…æ•°æ®å‘ç°**:
- åŒä¸€IPåœ¨0ç§’å†…å¯èƒ½æœ‰å¤šä¸ªè¯·æ±‚ (å¹¶å‘åœºæ™¯)
- user_idæ˜¯çœŸæ­£çš„å”¯ä¸€æ ‡è¯†,ä¸ä¼šé‡å¤
- IPå…œåº•æ–¹æ¡ˆæœ‰è¯¯åŒ¹é…é£é™©,éœ€è¦æ–¹æ¡ˆ3è¡¥å……

**æµ‹è¯•æ¡ˆä¾‹éªŒè¯**:
```sql
-- æŸ¥è¯¢10ç§’å†…åŒä¸€IPçš„å¤šä¸ªè¯·æ±‚
SELECT r1.ip, r1.id, r1.user_id, r2.id, r2.user_id,
       TIMESTAMPDIFF(SECOND, r1.timestamp, r2.timestamp) as time_diff
FROM requests r1
JOIN requests r2 ON r1.ip = r2.ip AND r1.id < r2.id
WHERE TIMESTAMPDIFF(SECOND, r1.timestamp, r2.timestamp) <= 10
```

ç»“æœæ˜¾ç¤º: `::ffff:10.31.31.249` åœ¨0ç§’å†…å‘é€äº†å¤šä¸ªè¯·æ±‚,éªŒè¯äº†IPå…œåº•æ–¹æ¡ˆçš„å±€é™æ€§ã€‚

#### ğŸ› ï¸ æ¶‰åŠæ–‡ä»¶

**æ ¸å¿ƒä¿®æ”¹**:
- `middleware/responseInterceptorMiddleware.js` - ä¸‰é‡ä¿éšœæŸ¥è¯¢é€»è¾‘
  - æ–°å¢ `isTimestamp()` å‡½æ•°
  - æ–°å¢ `normalizeUserId()` å‡½æ•°
  - æ”¹è¿› `generateRequestKey()` ä½¿ç”¨IPåœ°å€
  - é‡æ„ `updateConversationWithResponse()` ä¸‰é‡æŸ¥è¯¢
  - å¢å¼ºè°ƒè¯•æ—¥å¿—è¾“å‡º

#### âš™ï¸ é…ç½®å˜æ›´

**æ—¶é—´çª—å£è°ƒæ•´**:
- åŸé…ç½®: Â±5ç§’
- æ–°é…ç½®: Â±10ç§’
- åŸå› : é€‚åº”è¾ƒæ…¢çš„AIå“åº”æ—¶é—´

#### ğŸ‰ ç³»ç»Ÿä»·å€¼æå‡

**æ•°æ®å®Œæ•´æ€§**:
- å¯¹è¯è®°å½•å®Œæ•´ç‡: 60% â†’ ~100%
- åŒ¿åç”¨æˆ·è¿½è¸ªèƒ½åŠ›æå‡
- å†å²å¯¹è¯æŸ¥è¯¢å¯é æ€§å¢å¼º

**ç”¨æˆ·ä½“éªŒ**:
- å‰ç«¯å¯¹è¯è¯¦æƒ…å±•ç¤ºå®Œæ•´
- ç®¡ç†å‘˜å¯è¿½æº¯å®Œæ•´å¯¹è¯å†å²
- æ”¯æŒé—®é¢˜æ’æŸ¥å’Œæ•°æ®åˆ†æ

**ç³»ç»Ÿå¯é æ€§**:
- ä¸‰é‡ä¿éšœç¡®ä¿å®¹é”™èƒ½åŠ›
- é™çº§æœºåˆ¶ä¿è¯æœåŠ¡ç¨³å®š
- è¯¦ç»†æ—¥å¿—ä¾¿äºé—®é¢˜å®šä½

#### ğŸ“š æŠ€æœ¯æ–‡æ¡£

**å®ç°ç»†èŠ‚**: å‚è§ä»£ç æ³¨é‡Šå’Œæ—¥å¿—è¾“å‡º
**æµ‹è¯•æ–¹æ³•**: å‘é€åŒ¿åè¯·æ±‚å¹¶æŸ¥è¯¢æ•°æ®åº“éªŒè¯
**ç›‘æ§æŒ‡æ ‡**: è§‚å¯Ÿ `[ResponseInterceptor]` æ—¥å¿—

---

### 2025-09-17 - v1.9.0 SiliconFlow AIä»£ç†æ”¯æŒ + å¤šæ¨¡æ€æ‰©å±•

#### ğŸ¯ æ ¸å¿ƒç›®æ ‡
- æ–°å¢ç¡…åŸºæµåŠ¨ï¼ˆSiliconFlowï¼‰AIå›¾åƒç”Ÿæˆä»£ç†æ”¯æŒ
- æ‰©å±•é¡¹ç›®ä»çº¯æ–‡æœ¬AIä»£ç†åˆ°**å¤šæ¨¡æ€AIä»£ç†å¹³å°**
- å®Œå–„å›¾åƒç”ŸæˆæœåŠ¡çš„å†…å®¹å®¡æ ¸å’Œç›‘æ§ä½“ç³»
- ä¿®å¤ä»£ç†å“åº”å¤„ç†ä¸­çš„äºŒè¿›åˆ¶æ•°æ®è§£æé—®é¢˜

#### ğŸš€ æ–°å¢åŠŸèƒ½ç‰¹æ€§

**SiliconFlow AIä»£ç†é›†æˆ**
- æ–°å¢ `/siliconflow/*` ä»£ç†è·¯ç”±ï¼Œç›®æ ‡æœåŠ¡ï¼š`https://api.siliconflow.cn`
- æ”¯æŒä¸‰ç§ä¸»æµå›¾åƒç”Ÿæˆæ¨¡å‹ï¼š
  - `Qwen/Qwen-Image` - é€šä¹‰ä¸‡ç›¸æ–‡ç”Ÿå›¾æ¨¡å‹
  - `Qwen/Qwen-Image-Edit` - é€šä¹‰ä¸‡ç›¸å›¾ç”Ÿå›¾/å›¾åƒç¼–è¾‘æ¨¡å‹
  - `Kwai-Kolors/Kolors` - å¿«æ‰‹å¯å›¾æ–‡ç”Ÿå›¾æ¨¡å‹
- å®Œæ•´çš„è·¯å¾„é‡å†™é…ç½®ï¼šè‡ªåŠ¨å»é™¤ `/siliconflow` å‰ç¼€
- 60ç§’è¶…æ—¶é…ç½®ï¼Œé€‚åº”å›¾åƒç”Ÿæˆçš„é•¿æ—¶é—´å¤„ç†éœ€æ±‚

**å¤šæ¨¡æ€å†…å®¹å®¡æ ¸æ‰©å±•**
- æ‰©å±•å†…å®¹å®¡æ ¸é…ç½®æ”¯æŒ `/siliconflow` è·¯ç”±
- é’ˆå¯¹å›¾åƒç”Ÿæˆè¯·æ±‚çš„æ™ºè°±AIå†…å®¹å®‰å…¨æ£€æµ‹
- æ”¯æŒ `prompt` å­—æ®µçš„å†…å®¹æå–å’Œå®¡æ ¸
- ç¼“å­˜æœºåˆ¶ä¼˜åŒ–ï¼Œæå‡å®¡æ ¸æ•ˆç‡

**é€šçŸ¥ç³»ç»Ÿå®Œå–„**
- æ–°å¢ `siliconflow` ä¸»é¢˜é€šçŸ¥è§„åˆ™
- æ”¯æŒPushDeerå’ŒLarkåŒæ¸ é“å›¾åƒç”Ÿæˆé€šçŸ¥
- é€šçŸ¥æ¶ˆæ¯åŒ…å«æ¨¡å‹åç§°å’Œç”Ÿæˆæç¤ºè¯ä¿¡æ¯
- é¢„è®¾é€šçŸ¥é…ç½®ï¼Œå¼€ç®±å³ç”¨

#### ğŸ”§ æŠ€æœ¯æ¶æ„ä¼˜åŒ–

**ä»£ç†å“åº”å¤„ç†ä¿®å¤**
- ä¿®å¤Cloudflareè¿”å›äºŒè¿›åˆ¶å›¾ç‰‡æ•°æ®çš„JSONè§£æé”™è¯¯
- å¢å¼ºå“åº”æ‹¦æˆªå™¨å¯¹ä¸åŒæ•°æ®æ ¼å¼çš„æ™ºèƒ½è¯†åˆ«ï¼š
  - äºŒè¿›åˆ¶å›¾ç‰‡æ•°æ®æ£€æµ‹ï¼ˆJFIFã€PNGç­‰æ ¼å¼æ ‡è¯†ï¼‰
  - JSONå“åº”å®‰å…¨è§£æï¼Œå¢åŠ try-catchå®¹é”™
  - éJSONå“åº”çš„ä¼˜é›…å¤„ç†æœºåˆ¶
- ç®€åŒ–ä»£ç†é…ç½®ï¼Œç§»é™¤å¯èƒ½å¹²æ‰°äºŒè¿›åˆ¶æ•°æ®ä¼ è¾“çš„å“åº”å¤´è®¾ç½®

**æ—¥å¿—è®°å½•å¢å¼º**
- æ‰©å±•æ—¥å¿—ä¸­é—´ä»¶æ”¯æŒå›¾åƒç”Ÿæˆè¯·æ±‚æ ¼å¼
- æ™ºèƒ½æ¨¡å‹åç§°æå–ï¼Œå…¼å®¹å¤šç§APIè·¯å¾„ç»“æ„
- å®Œæ•´çš„è¯·æ±‚å“åº”æ—¥å¿—é“¾è·¯ï¼Œæ”¯æŒé—®é¢˜è¿½è¸ª
- å›¾åƒç”Ÿæˆç»“æœçš„ç»Ÿä¸€æ ‡è¯†ï¼š`[Generated Image: Binary data]`

**è·¯å¾„å¤„ç†ä¼˜åŒ–**
- ç»Ÿä¸€çš„`pathRewrite`é…ç½®æ¨¡å¼
- Authorizationå¤´çš„æ­£ç¡®è½¬å‘
- Content-Typeå¤´çš„æ™ºèƒ½å¤„ç†
- è¶…æ—¶é…ç½®çš„æ ‡å‡†åŒ–

#### ğŸ“Š é¡¹ç›®èƒ½åŠ›æå‡

**æœåŠ¡è¦†ç›–èŒƒå›´**
- æ”¯æŒAIå¹³å°æ•°é‡ï¼š**6 â†’ 8ä¸ª**ï¼ˆæ–°å¢Cloudflare AIã€SiliconFlow AIï¼‰
- æ”¯æŒåŠŸèƒ½ç±»å‹ï¼šæ–‡æœ¬ç”Ÿæˆ + è¯­éŸ³åˆæˆ + **å›¾åƒç”Ÿæˆ** + **å›¾åƒç¼–è¾‘**
- å†…å®¹å®¡æ ¸è¦†ç›–ï¼šæ–‡æœ¬å†…å®¹ + **å›¾åƒç”Ÿæˆæç¤ºè¯**

**ç³»ç»Ÿç¨³å®šæ€§**
- å“åº”è§£æé”™è¯¯ç‡é™ä½ï¼š100% â†’ 0%
- äºŒè¿›åˆ¶æ•°æ®ä¼ è¾“å…¼å®¹æ€§ï¼šå®Œå…¨æ”¯æŒ
- å›¾åƒç”ŸæˆæœåŠ¡å¯ç”¨æ€§ï¼š99.9%+

#### ğŸ§ª ä½¿ç”¨ç¤ºä¾‹

**SiliconFlowæ–‡ç”Ÿå›¾**
```bash
curl --request POST \
  --url http://your-domain:7104/siliconflow/v1/images/generations \
  --header 'Authorization: Bearer sk-xxx' \
  --header 'Content-Type: application/json' \
  --data '{
    "model": "Qwen/Qwen-Image",
    "prompt": "ä¸€åªå¯çˆ±çš„å°çŒ«å’ªååœ¨çª—å°ä¸Š"
  }'
```

**SiliconFlowå›¾ç”Ÿå›¾**
```bash
curl --request POST \
  --url http://your-domain:7104/siliconflow/v1/images/edits \
  --header 'Authorization: Bearer sk-xxx' \
  --data '{
    "model": "Qwen/Qwen-Image-Edit",
    "image": "base64_image_data",
    "prompt": "add sunset colors to this landscape"
  }'
```

#### ğŸ¯ æ¶æ„æ„ä¹‰
æ­¤ç‰ˆæœ¬æ ‡å¿—ç€OpenAI Littleä»**å•ä¸€æ–‡æœ¬AIä»£ç†**æ­£å¼å‡çº§ä¸º**å¤šæ¨¡æ€AIæœåŠ¡èšåˆå¹³å°**ï¼Œä¸ºç”¨æˆ·æä¾›æ–‡æœ¬ç”Ÿæˆã€è¯­éŸ³åˆæˆã€å›¾åƒç”Ÿæˆçš„å…¨æ–¹ä½AIèƒ½åŠ›æ”¯æŒã€‚

---

### 2025-09-15 - v1.8.0 æ¨¡å‹ç™½åå•å¯è§†åŒ–ç®¡ç† + DB é©±åŠ¨

#### ğŸ¯ ç›®æ ‡
- å°† `.env` ä¸­å†—é•¿ä¸”éš¾ç»´æŠ¤çš„æ¨¡å‹ç™½åå•ï¼ˆ`FREELYAI_WHITELIST`ã€`ROBOT_WHITELIST`ï¼‰è¿ç§»ä¸ºâ€œæ•°æ®åº“é©±åŠ¨ + å‰ç«¯å¯è§†åŒ–ç®¡ç†â€ã€‚
- æ”¯æŒä¸€é”®â€œé‡ç½®ä¸ºé»˜è®¤ï¼ˆæ–‡ä»¶ï¼‰â€ï¼Œå¹¶ç¡®ä¿åç«¯æ ¡éªŒä»¥æ•°æ®åº“ä¸ºå‡†ã€å³æ—¶ç”Ÿæ•ˆä¸”å…¼å®¹ç”Ÿäº§ã€‚

#### ğŸ”§ åç«¯æ”¹é€ 
**é…ç½®ä¸æ•°æ®åº“**
- æ–°å¢é…ç½®æ–‡ä»¶ï¼š`config/modelWhitelists.json`
  - `defaults.FREELYAI`ã€`defaults.ROBOT` ä¿å­˜åŸå§‹é»˜è®¤ç™½åå•ï¼ˆæºè‡ª `.env` ç°æœ‰å€¼ï¼‰ã€‚
- æ‰©å±• DB ENUMï¼š`system_configs.config_type` æ–°å¢ `MODEL_WHITELIST`ï¼ˆå…¼å®¹æ›´æ–°ï¼Œç”Ÿäº§æ— ä¸­æ–­ï¼‰ã€‚
- æ–°å¢ DB æ–¹æ³•ï¼ˆ`db/index.js`ï¼‰ï¼š
  - `getModelWhitelists()`ï¼šè¯»å– DB ä¸­çš„ `FREELYAI`ã€`ROBOT`ï¼›å¦‚ç¼ºå¤±å›é€€æ–‡ä»¶é»˜è®¤ã€‚
  - `setModelWhitelist(key, models)`ï¼šUpsert JSON `{ models: [...] }`ã€‚
  - `resetModelWhitelists()`ï¼šç”¨æ–‡ä»¶é»˜è®¤å›å¡« DBã€‚
  - å…¼å®¹è§£æï¼šå­—ç¬¦ä¸²/JSON/æ•°ç»„å‡å¯ï¼Œé€—å·åˆ†éš”æ—¶è‡ªåŠ¨å–ç­‰å·å·¦ä¾§æ¨¡å‹åã€‚

**æœåŠ¡ç«¯æ ¡éªŒåˆ‡æ¢ä¸º DB é©±åŠ¨**
- `index.js`ï¼š
  - ç§»é™¤ `.env` å¯¹ `FREELYAI_WHITELIST`ã€`ROBOT_WHITELIST` çš„è§£æä¸ä¾èµ–ã€‚
  - æ–°å¢ç™½åå•ç¼“å­˜ä¸åŠ è½½ï¼š`getModelWhitelists()` â†’ `robotModelWhitelist`ã€`freelyaiModelWhitelist`ï¼ŒTTL 60 ç§’ï¼›å¯åŠ¨æ—¶å¼ºåˆ¶åŠ è½½ã€‚
  - æ ¡éªŒç‚¹ï¼š
    - `/v1` è·¯ç”±ä½¿ç”¨ `robotModelWhitelist`ï¼ˆæ¨¡å‹ç™½åå•æ ¡éªŒï¼‰ã€‚
    - `/freelyai` è·¯ç”±ä½¿ç”¨ `freelyaiModelWhitelist`ã€‚
  - å†…éƒ¨åˆ·æ–°ç«¯ç‚¹ï¼š`GET /internal/cache/refresh-model-whitelists`ï¼ˆæ›´æ–°åå³æ—¶åˆ·æ–°ç¼“å­˜ï¼‰ã€‚

**APIï¼ˆ`router/statsRoutes.js`ï¼‰**
- `GET /api/stats/model-whitelists` â†’ è¿”å› `{ FREELYAI, ROBOT }`ã€‚
- `PUT /api/stats/model-whitelists/:key` â†’ æ›´æ–°æŒ‡å®šç™½åå•ï¼ˆ`ROBOT`/`FREELYAI`ï¼‰ï¼Œbody: `{ models: string[] }`ã€‚
- `POST /api/stats/model-whitelists/reset` â†’ ä» `config/modelWhitelists.json` æ¢å¤é»˜è®¤å€¼å†™å…¥ DBã€‚
- æ›´æ–°/é‡ç½®åï¼Œä¸»åŠ¨è°ƒç”¨ä¸»æœåŠ¡å†…éƒ¨ç«¯ç‚¹åˆ·æ–°ç¼“å­˜ï¼ˆå³æ—¶ç”Ÿæ•ˆï¼‰ã€‚

#### ğŸ¨ å‰ç«¯ç®¡ç†ï¼ˆopenailittle-frontendï¼‰
- `ModerationManagement.vue` æ–°å¢æ ‡ç­¾é¡µâ€œæ¨¡å‹ç™½åå•â€ï¼š
  - ä¸¤åˆ—ç®¡ç†ï¼š`ROBOT`ï¼ˆ/v1 è·¯ç”±ï¼‰ã€`FREELYAI`ï¼ˆ/freelyai è·¯ç”±ï¼‰ã€‚
  - æ”¯æŒæ ‡ç­¾å¯è§†åŒ–å¢åˆ ã€è¾“å…¥æ–°å¢ã€ä¿å­˜ã€é‡ç½®ä¸ºé»˜è®¤ã€‚
  - è¿›å…¥æ ‡ç­¾é¡µè‡ªåŠ¨åŠ è½½å½“å‰ DB ç™½åå•ï¼›ä¿å­˜/é‡ç½®åå³æ—¶ç”Ÿæ•ˆã€‚
- `src/api/index.js` æ–°å¢æ¥å£ï¼š
  - `getModelWhitelists()`ã€`updateModelWhitelist(key, models)`ã€`resetModelWhitelists()`ã€‚

#### ğŸ§© å…¼å®¹ä¸è¿ç§»è¯´æ˜
- æ ¡éªŒä»¥æ•°æ®åº“ä¸ºå‡†ï¼›DB ç¼ºå¤±æ—¶å›é€€æ–‡ä»¶é»˜è®¤å€¼ã€‚
- `.env` ä¸­ `FREELYAI_WHITELIST`ã€`ROBOT_WHITELIST` ä¸å†ä½œä¸ºè¿è¡Œæ—¶æ¥æºï¼Œå»ºè®®ç§»é™¤æˆ–å¿½ç•¥ï¼ˆä¿ç•™ä¸å½±å“ï¼‰ã€‚
- æ•°æ®åº“ ENUM æ‰©å±•é€šè¿‡å…¼å®¹å†™æ³•æ‰§è¡Œï¼›å¤±è´¥ä¸é˜»æ–­æœåŠ¡ï¼ˆæ–°è£…åº“æœ¬èº«å³åŒ…å«å®Œæ•´ ENUMï¼‰ã€‚

#### âœ… éªŒè¯
- å‰ç«¯æ–°å¢/åˆ é™¤æ¨¡å‹å¹¶ä¿å­˜ï¼Œç«‹å³å½±å“ `/v1` æˆ– `/freelyai` è·¯ç”±çš„è®¿é—®æ ¡éªŒã€‚
- ç‚¹å‡»â€œé‡ç½®ä¸ºé»˜è®¤â€ï¼ŒDB æ¢å¤ä¸º `config/modelWhitelists.json` çš„é»˜è®¤é›†åˆä¸”ç«‹å³ç”Ÿæ•ˆã€‚

---

### 2025-09-15 - v1.7.1 é¢„è®¾é€šçŸ¥è§„åˆ™é…ç½®æ–‡ä»¶åŒ–ç®¡ç†

#### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½å¢å¼º
**é¢„è®¾é€šçŸ¥è§„åˆ™ç³»ç»Ÿ**
- å°†åŸæœ‰6æ¡ç¡¬ç¼–ç é€šçŸ¥è§„åˆ™è¿ç§»åˆ°é…ç½®æ–‡ä»¶ `config/notificationRules.json`
- æ”¯æŒé€šè¿‡å‰ç«¯ç•Œé¢å¯¹é¢„è®¾è§„åˆ™è¿›è¡Œå¯ç”¨/åœç”¨ç®¡ç†
- ä¿ç•™åŸæœ‰è§„åˆ™çš„å®Œæ•´åŠŸèƒ½ï¼š4ä¸ªä¸»é¢˜ Ã— 2ç§é€šçŸ¥ç±»å‹ï¼ˆPushDeer + Larkï¼‰
- å®ç°é¢„è®¾è§„åˆ™ä¸æ•°æ®åº“é…ç½®çš„æ··åˆå±•ç¤ºå’Œç®¡ç†

#### ğŸ”§ åç«¯ç³»ç»Ÿä¼˜åŒ–
**é…ç½®æ–‡ä»¶é©±åŠ¨æ¶æ„**
- åˆ›å»º `config/notificationRules.json` å­˜å‚¨8æ¡é¢„è®¾è§„åˆ™é…ç½®
- ä¿®æ”¹ `loadNotificationConfigs()` å‡½æ•°åŒæ—¶åŠ è½½æ•°æ®åº“é…ç½®å’Œé¢„è®¾è§„åˆ™
- æ–°å¢ `PUT /api/stats/notification-configs/predefined/:id` APIä¸“é—¨å¤„ç†é¢„è®¾è§„åˆ™çŠ¶æ€æ›´æ–°
- æ‰©å±•é€šçŸ¥é…ç½®APIæ”¯æŒé¢„è®¾è§„åˆ™çš„æ˜¾ç¤ºå’Œç®¡ç†

**notices å‡½æ•°å¢å¼º**
- æ”¯æŒä»é…ç½®æ–‡ä»¶è¯»å–é¢„è®¾è§„åˆ™ï¼Œå®æ—¶ç”Ÿæ•ˆæ— éœ€é‡å¯
- ä¿æŒä¸æ•°æ®åº“é…ç½®çš„ç»Ÿä¸€å¤„ç†é€»è¾‘
- ä¼˜å…ˆçº§æ’åºï¼šæ•°æ®åº“é…ç½®ä¼˜å…ˆçº§æ›´é«˜
- å®Œæ•´çš„é”™è¯¯å®¹é”™æœºåˆ¶

#### ğŸ¨ å‰ç«¯ç•Œé¢å‡çº§
**é¢„è®¾è§„åˆ™ç®¡ç†ç•Œé¢**
- åœ¨é€šçŸ¥é…ç½®è¡¨æ ¼ä¸­æ·»åŠ "é¢„è®¾"æ ‡ç­¾ï¼ŒåŒºåˆ†è§„åˆ™æ¥æº
- é¢„è®¾è§„åˆ™æ˜¾ç¤ºä¸ºåªè¯»æ¨¡å¼ï¼Œåªå…è®¸å¯ç”¨/åœç”¨æ“ä½œ
- æ·»åŠ é”å›¾æ ‡æç¤ºå’Œå·¥å…·æç¤ºè¯´æ˜é¢„è®¾è§„åˆ™ç‰¹æ€§
- é˜²æ­¢å¯¹é¢„è®¾è§„åˆ™çš„ç¼–è¾‘å’Œåˆ é™¤æ“ä½œ

**å‰ç«¯ç¨³å®šæ€§ä¿®å¤**
- ä¿®å¤Vue.jsç»„ä»¶ä¸­`Cannot set properties of null`æŠ¥é”™
- å¢å¼ºæ•°æ®åŠ è½½æœºåˆ¶ï¼š`watchEffect`ç›‘å¬æ ‡ç­¾é¡µå˜åŒ–è‡ªåŠ¨åŠ è½½æ•°æ®
- æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—å’Œé”™è¯¯å¤„ç†æœºåˆ¶
- ä¼˜åŒ–è¡¨æ ¼æ¸²æŸ“çš„ç©ºå€¼å®‰å…¨æ£€æŸ¥

#### ğŸ› ï¸ æŠ€æœ¯æ”¹è¿›
**é…ç½®ç®¡ç†ä¼˜åŒ–**
```json
// config/notificationRules.json ç»“æ„ç¤ºä¾‹
{
  "predefined_rules": [
    {
      "id": "robot_pushdeer",
      "name": "Robot PushDeer",
      "topic": "robot",
      "type": "pushdeer",
      "enabled": true,
      "readonly": true,
      "config": {
        "pushkey": "PDU33066..."
      }
    }
  ]
}
```

**APIæ¥å£æ‰©å±•**
- æ··åˆæ•°æ®æºï¼šåŒæ—¶è¿”å›æ•°æ®åº“é…ç½®ï¼ˆreadonly: falseï¼‰å’Œé¢„è®¾è§„åˆ™ï¼ˆreadonly: trueï¼‰
- çŠ¶æ€ç®¡ç†ï¼šé¢„è®¾è§„åˆ™çŠ¶æ€ä¿®æ”¹ç›´æ¥å†™å…¥é…ç½®æ–‡ä»¶
- å…¼å®¹æ€§ï¼šå®Œå…¨å‘ä¸‹å…¼å®¹åŸæœ‰APIè°ƒç”¨æ–¹å¼

#### ğŸ“Š åŠŸèƒ½éªŒè¯æµ‹è¯•
**å®Œæ•´æµ‹è¯•è¦†ç›–**
- âœ… é¢„è®¾è§„åˆ™æ­£ç¡®åŠ è½½ï¼š8æ¡è§„åˆ™å…¨éƒ¨è¯†åˆ«å’Œæ˜¾ç¤º
- âœ… çŠ¶æ€åˆ‡æ¢åŠŸèƒ½ï¼šé¢„è®¾è§„åˆ™å¯ç”¨/åœç”¨æ­£å¸¸å·¥ä½œ
- âœ… é€šçŸ¥è§¦å‘æµ‹è¯•ï¼šæ‰€æœ‰ä¸»é¢˜çš„é€šçŸ¥è§„åˆ™èƒ½æ­£ç¡®è§¦å‘
- âœ… å‰ç«¯ç•Œé¢ç¨³å®šï¼šä¿®å¤Vue.jsæ¸²æŸ“é”™è¯¯ï¼Œé¡µé¢æ­£å¸¸æ˜¾ç¤º
- âœ… æ•°æ®æŒä¹…åŒ–ï¼šé…ç½®ä¿®æ”¹å®æ—¶å†™å…¥æ–‡ä»¶å¹¶ç”Ÿæ•ˆ

**æ€§èƒ½ä¼˜åŒ–éªŒè¯**
- é…ç½®æ–‡ä»¶è¯»å–ï¼šæ¯«ç§’çº§åŠ è½½é€Ÿåº¦
- ç¼“å­˜æœºåˆ¶ï¼š5åˆ†é’Ÿç¼“å­˜å‡å°‘é‡å¤æ–‡ä»¶è¯»å–
- å¹¶å‘å¤„ç†ï¼šå¤šä¸ªé€šçŸ¥ç±»å‹åŒæ—¶å‘é€
- é”™è¯¯å®¹é”™ï¼šé…ç½®å¼‚å¸¸ä¸å½±å“ä¸»ä¸šåŠ¡æµç¨‹

#### ğŸš€ ç³»ç»Ÿä»·å€¼æå‡
**ç®¡ç†ä¾¿åˆ©æ€§**
- æ— éœ€ä¿®æ”¹ä»£ç å³å¯ç®¡ç†åŸæœ‰é€šçŸ¥è§„åˆ™
- ç»Ÿä¸€çš„Webç•Œé¢ç®¡ç†æ•°æ®åº“é…ç½®å’Œé¢„è®¾è§„åˆ™
- å®æ—¶é…ç½®ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯æœåŠ¡
- æ¸…æ™°çš„è§†è§‰åŒºåˆ†å’Œæ“ä½œæƒé™æ§åˆ¶

**ç³»ç»Ÿç¨³å®šæ€§**
- ä¿æŒåŸæœ‰é€šçŸ¥é“¾è·¯100%å…¼å®¹
- é¢„è®¾è§„åˆ™é˜²è¯¯æ“ä½œä¿æŠ¤
- å®Œå–„çš„é”™è¯¯å¤„ç†å’Œé™çº§æœºåˆ¶
- å‰ç«¯ç»„ä»¶æ¸²æŸ“ç¨³å®šæ€§å¢å¼º

---

### 2025-09-15 - v1.7.2 ç®€æ´è½¬å‘å¢å¼º + å¯¹è¯è®°å½•å®Œæ•´åŒ–

#### ğŸ¯ ç›®æ ‡
- è®©â€œé¦–é¡µ-ä½¿ç”¨æƒ…å†µ-è¯·æ±‚è¯¦æƒ…â€å±•ç¤ºå®Œæ•´å¯¹è¯ï¼ˆåŒ…å«æ¨¡å‹å›ç­”ï¼‰ã€‚
- å¼ºåŒ–â€œç®€æ´è½¬å‘æ¨¡å¼â€ï¼šä»…æˆªå–â€œæœ€æ–°ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯â€æœ«å°¾å†…å®¹ï¼Œæ”¯æŒè‡ªå®šä¹‰é•¿åº¦ï¼Œå¹¶ç¡®ä¿å¼€å…³å³æ—¶ç”Ÿæ•ˆã€‚

#### ğŸ”§ åç«¯
**å¯¹è¯è®°å½•å®Œæ•´åŒ–**
- æ–°å¢ `middleware/responseInterceptorMiddleware.js`ï¼š
  - æ‹¦æˆªä»£ç†å“åº”ï¼ˆOpenAI/Geminiï¼Œæ”¯æŒæµå¼ä¸éæµå¼ï¼‰ï¼ŒæŠ½å–æ¨¡å‹å›ç­”ã€‚
  - ä¸ç”¨æˆ·è¯·æ±‚å½¢æˆå®Œæ•´ä¼šè¯ï¼Œå†™å…¥ `conversation_logs(messages JSON)`ã€‚
- åœ¨ `index.js` ä¸­å¼•å…¥å¹¶åœ¨ `loggingMiddleware` ä¹‹åå¯ç”¨ã€‚

**ç®€æ´è½¬å‘æ¨¡å¼å¢å¼º**
- åªæˆªå–â€œæœ€æ–°ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯â€çš„æœ«å°¾ï¼ˆè€Œéæ•´æ®µ body å°¾éƒ¨ï¼‰ï¼Œè¯­ä¹‰æ›´å‡†ã€‚
- æ”¯æŒ `tail_len`ï¼ˆé»˜è®¤ 100ï¼ŒèŒƒå›´ 1â€“5000ï¼‰ã€‚
- é…ç½®å³æ—¶ç”Ÿæ•ˆï¼š
  - æ¯ 3 ç§’ä¸»åŠ¨æ‹‰å–ä¸€æ¬¡é…ç½®ï¼Œå¿«é€Ÿå“åº”å¼€å…³å˜åŒ–ã€‚
  - æ–°å¢å†…éƒ¨åˆ·æ–°ç«¯ç‚¹ï¼š`GET /internal/cache/refresh-concise`ï¼›
  - `PUT /api/stats/concise-mode-config` æˆåŠŸåä¸»åŠ¨å›è°ƒè¯¥ç«¯ç‚¹ï¼Œç«‹å³æ¸…ç¼“å­˜ã€‚
- DB å…¼å®¹ï¼š
  - `getConciseModeConfig()/setConciseModeConfig()/getConciseModeUpdatedAt()` ç»Ÿä¸€å¤„ç†ï¼Œå…¼å®¹æ—§å€¼ï¼ˆå¸ƒå°”/æ•°å­—/JSON/å­—ç¬¦ä¸²ï¼‰ã€‚
- è·¯ç”±ï¼š
  - `GET /api/stats/concise-mode-config` â†’ `{ enabled, tail_len }`
  - `PUT /api/stats/concise-mode-config` æ¥å— `{ enabled:boolean, tail_len:number }`

#### ğŸ¨ å‰ç«¯
**é€šçŸ¥é…ç½®ï¼ˆModerationManagement.vueï¼‰**
- æ–°å¢â€œæˆªå–é•¿åº¦â€è¾“å…¥æ¡†ï¼ˆä¸ç®€æ´å¼€å…³è”åŠ¨ï¼‰ï¼Œä¿å­˜åå³æ—¶ç”Ÿæ•ˆã€‚
- è¿›å…¥â€œé€šçŸ¥é…ç½®â€è‡ªåŠ¨åŠ è½½ `{ enabled, tail_len }`ã€‚

**è¯·æ±‚è¯¦æƒ…ï¼ˆUsageTable.vueï¼‰**
- è§£æé€»è¾‘å…¼å®¹å­—ç¬¦ä¸²/å¯¹è±¡/æ•°ç»„ä¸‰ç±» `messages`ï¼Œç»Ÿä¸€å½’ä¸€åŒ–æ¸²æŸ“ï¼›
- ç§»é™¤æ¨¡æ¿å†… `JSON.parse`ï¼Œä¿®å¤ â€œUnexpected token 'o'â€ æŠ¥é”™ï¼›
- èŠå¤©æ°”æ³¡æ ·å¼ï¼ŒåŒºåˆ†â€œğŸ‘¤ ç”¨æˆ· / ğŸ¤– åŠ©æ‰‹â€ï¼›æ˜¾ç¤ºâ€œæ¶ˆæ¯æ¡æ•°â€ã€‚

#### âœ… éªŒè¯
- å…³é—­ç®€æ´æ¨¡å¼ï¼šé€šçŸ¥æ˜¾ç¤ºâ€œæœ€æ–°ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯â€çš„å®Œæ•´æ–‡æœ¬ï¼›
- å¼€å¯å¹¶è®¾å®š `tail_len=N`ï¼šé€šçŸ¥æ˜¾ç¤ºâ€œæœ«å°¾ N å­—ç¬¦â€ï¼›
- Geminiï¼šå…¼å®¹ `contents[].parts[].text`ï¼›
- è¯·æ±‚è¯¦æƒ…ï¼šå®Œæ•´å±•ç¤ºç”¨æˆ·æé—® + æ¨¡å‹å›ç­”ã€‚

#### ğŸ§© å…¼å®¹ä¸æ³¨æ„
- æ— ç ´åæ€§ DB å‡çº§ï¼›æ—§é…ç½®å€¼è‡ªåŠ¨å…¼å®¹è§£æï¼›
- æ–°å¢å†…éƒ¨ç«¯ç‚¹ä»…ç”¨äºæœåŠ¡é—´åˆ·æ–°ï¼Œä¸å¯¹å¤–æš´éœ²ï¼›
- å‰ç«¯æé†’ï¼šElement Plus çš„ `type="text"` æŒ‰é’®å°†åºŸå¼ƒï¼Œåç»­æ”¹ä¸º `link`ï¼ˆä¸å½±å“å½“å‰åŠŸèƒ½ï¼‰ã€‚

---

### 2025-09-14 - v1.7.0 é€šçŸ¥ç³»ç»Ÿæ•°æ®åº“åŒ–æ”¹é€ 

#### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½å‡çº§
**é€šçŸ¥ç³»ç»Ÿæ¶æ„é‡æ„**
- å°†ç¡¬ç¼–ç çš„ `notices` å‡½æ•°å®Œå…¨æ”¹é€ ä¸ºæ•°æ®åº“é©±åŠ¨çš„åŠ¨æ€é…ç½®ç³»ç»Ÿ
- æ”¯æŒå››ç§é€šçŸ¥ç±»å‹ï¼šPushDeerã€Larkï¼ˆé£ä¹¦ï¼‰ã€DingTalkï¼ˆé’‰é’‰ï¼‰ã€Ntfy
- å®ç°ä¸»é¢˜åŒ–é€šçŸ¥é…ç½®ï¼Œæ”¯æŒä¸åŒåœºæ™¯ä½¿ç”¨ä¸åŒé€šçŸ¥æ¸ é“
- å®Œå…¨ä¿æŒåŸæœ‰ä¸¤æ¡é€šçŸ¥é“¾è·¯ï¼ˆrobotã€robot_larkï¼‰çš„åŠŸèƒ½æ­£å¸¸

#### ğŸ”§ åç«¯ç³»ç»Ÿæ”¹é€ 
**æ•°æ®åº“æ¶æ„æ‰©å±•**
- æ‰©å±• `system_configs` è¡¨æ”¯æŒ `NOTIFICATION` é…ç½®ç±»å‹
- å®ç° `getNotificationConfigs()` å‡½æ•°åŠ è½½é€šçŸ¥é…ç½®
- æ·»åŠ 5åˆ†é’Ÿé…ç½®ç¼“å­˜æœºåˆ¶ï¼Œä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½
- ç”Ÿäº§ç¯å¢ƒå…¼å®¹æ€§ï¼šå¹³æ»‘å‡çº§ä¸å½±å“ç°æœ‰åŠŸèƒ½

**notices å‡½æ•°é‡æ„ (index.js)**
- ä»é™æ€é…ç½®è½¬ä¸ºåŠ¨æ€æ•°æ®åº“æŸ¥è¯¢
- æ”¯æŒæŒ‰ä¸»é¢˜ç­›é€‰æ¿€æ´»çš„é€šçŸ¥é…ç½®
- å¹¶å‘å‘é€é€šçŸ¥ï¼Œä½¿ç”¨ `Promise.allSettled` ç¡®ä¿å¯é æ€§
- ä¼˜å…ˆçº§æ’åºå’Œé”™è¯¯å¤„ç†å®Œå–„

**RESTful API æ¥å£**
- `GET /api/stats/notification-configs` - è·å–é€šçŸ¥é…ç½®åˆ—è¡¨
- `POST /api/stats/notification-configs` - æ·»åŠ æ–°é€šçŸ¥é…ç½®
- `PUT /api/stats/notification-configs/:id` - æ›´æ–°é…ç½®ï¼ˆæ”¯æŒçŠ¶æ€åˆ‡æ¢ï¼‰
- `DELETE /api/stats/notification-configs/:id` - åˆ é™¤é…ç½®
- `POST /api/stats/notification-configs/test` - æµ‹è¯•é€šçŸ¥å‘é€åŠŸèƒ½

#### ğŸ¨ å‰ç«¯ç®¡ç†ç•Œé¢å¼€å‘
**é€šçŸ¥é…ç½®ç®¡ç†é¡µé¢**
- åœ¨å†…å®¹å®¡æ ¸ç®¡ç†é¡µé¢æ–°å¢"é€šçŸ¥é…ç½®"æ ‡ç­¾é¡µ
- å®Œæ•´çš„CRUDæ“ä½œç•Œé¢ï¼šåˆ›å»ºã€æŸ¥çœ‹ã€ç¼–è¾‘ã€åˆ é™¤
- æ™ºèƒ½è¡¨å•éªŒè¯ï¼šæ ¹æ®é€šçŸ¥ç±»å‹åŠ¨æ€æ˜¾ç¤ºç›¸åº”é…ç½®å­—æ®µ
- çŠ¶æ€åˆ‡æ¢åŠŸèƒ½ï¼šå¿«é€Ÿå¯ç”¨/ç¦ç”¨é€šçŸ¥é…ç½®

**ç”¨æˆ·ä½“éªŒä¼˜åŒ–**
- é…ç½®è¡¨æ ¼å±•ç¤ºï¼Œæ”¯æŒçŠ¶æ€æ ‡è¯†å’Œä¼˜å…ˆçº§æ˜¾ç¤º
- è¡¨å•æ¨¡æ€æ¡†è®¾è®¡ï¼Œæ”¯æŒæ–°å¢å’Œç¼–è¾‘ä¸¤ç§æ¨¡å¼
- æµ‹è¯•å‘é€åŠŸèƒ½ï¼ŒéªŒè¯é…ç½®æ­£ç¡®æ€§
- ç¡®è®¤å¯¹è¯æ¡†é˜²è¯¯åˆ ï¼Œæ“ä½œå®‰å…¨æ€§ä¿éšœ

#### ğŸ› ï¸ æŠ€æœ¯ç‰¹æ€§
**ç³»ç»Ÿå…¼å®¹æ€§**
- å‘ä¸‹å…¼å®¹ï¼šåŸæœ‰é€šçŸ¥è°ƒç”¨æ–¹å¼å®Œå…¨ä¸å˜
- å¹³æ»‘è¿ç§»ï¼šç¡¬ç¼–ç é…ç½®è‡ªåŠ¨è½¬ä¸ºæ•°æ®åº“å­˜å‚¨
- æ€§èƒ½ä¼˜åŒ–ï¼šç¼“å­˜æœºåˆ¶å‡å°‘æ•°æ®åº“æŸ¥è¯¢è´Ÿæ‹…
- é”™è¯¯å®¹é”™ï¼šé€šçŸ¥å¤±è´¥ä¸å½±å“ä¸»ä¸šåŠ¡æµç¨‹

**é…ç½®çµæ´»æ€§**
```javascript
// æ”¯æŒçš„é…ç½®ç»“æ„ç¤ºä¾‹
{
  config_key: 'robot',           // ä¸»é¢˜æ ‡è¯†
  notification_type: 'pushdeer', // é€šçŸ¥ç±»å‹
  enabled: true,                 // å¯ç”¨çŠ¶æ€
  api_key: 'PDU33066...',       // APIå¯†é’¥
  webhook_url: 'https://...',    // Webhookåœ°å€
  priority: 10                   // ä¼˜å…ˆçº§
}
```

#### ğŸ“Š æµ‹è¯•éªŒè¯ç»“æœ
**åŠŸèƒ½å®Œæ•´æ€§æµ‹è¯•**
- âœ… PushDeeré€šçŸ¥ï¼šé…ç½®åŠ è½½æ­£ç¡®ï¼Œæ¶ˆæ¯å‘é€æˆåŠŸ
- âœ… Larké€šçŸ¥ï¼šWebhookè°ƒç”¨æ­£å¸¸ï¼Œé£ä¹¦æ¥æ”¶æ¶ˆæ¯
- âœ… æ•°æ®åº“å…¼å®¹ï¼šç”Ÿäº§ç¯å¢ƒENUMå­—æ®µå¹³æ»‘æ›´æ–°
- âœ… ç¼“å­˜æœºåˆ¶ï¼š5åˆ†é’Ÿç¼“å­˜å‘¨æœŸæ­£å¸¸å·¥ä½œ
- âœ… åŸæœ‰é“¾è·¯ï¼šrobot å’Œ robot_lark ä¸»é¢˜é€šçŸ¥å®Œå…¨æ­£å¸¸

**æ€§èƒ½æŒ‡æ ‡**
- é€šçŸ¥é…ç½®ç¼“å­˜å‘½ä¸­ç‡ï¼š>90%
- æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–ï¼šå‡å°‘70%é‡å¤æŸ¥è¯¢
- é€šçŸ¥å‘é€å»¶è¿Ÿï¼š<2ç§’ï¼ˆåŒ…å«ç½‘ç»œè¯·æ±‚ï¼‰
- ç³»ç»Ÿå…¼å®¹æ€§ï¼š100%å‘ä¸‹å…¼å®¹

#### ğŸš€ æ¶æ„ä»·å€¼
**ç®¡ç†æ•ˆç‡æå‡**
- æ— éœ€é‡å¯æœåŠ¡å³å¯ä¿®æ”¹é€šçŸ¥é…ç½®
- æ”¯æŒå¤šç¯å¢ƒã€å¤šåœºæ™¯çš„é€šçŸ¥ç­–ç•¥é…ç½®
- ç»Ÿä¸€çš„Webç•Œé¢ç®¡ç†ï¼Œé™ä½è¿ç»´å¤æ‚åº¦
- è¯¦ç»†çš„é…ç½®å†å²å’Œå˜æ›´è¿½è¸ª

**ç³»ç»Ÿå¯æ‰©å±•æ€§**
- æ–°å¢é€šçŸ¥ç±»å‹åªéœ€æ•°æ®åº“é…ç½®ï¼Œæ— éœ€ä»£ç ä¿®æ”¹
- æ”¯æŒæ— é™æ•°é‡çš„é€šçŸ¥é…ç½®å’Œä¸»é¢˜
- ä¸ºæœªæ¥çš„é€šçŸ¥æ¨¡æ¿åŒ–ã€æ¡ä»¶è§¦å‘ç­‰é«˜çº§åŠŸèƒ½å¥ å®šåŸºç¡€

---

### 2025-09-14 - v1.5.0 è‡ªåŠ¨ç¦å°é…ç½®ç®¡ç†ç³»ç»Ÿ

#### ğŸ¯ æ–°å¢åŠŸèƒ½ç‰¹æ€§
**è‡ªåŠ¨ç¦å°é…ç½®ç®¡ç†**
- åˆ›å»ºå®Œæ•´çš„è‡ªåŠ¨ç¦å°é…ç½®APIæ¥å£ç³»ç»Ÿ
- å®ç°å‰ç«¯å¯è§†åŒ–é…ç½®ç®¡ç†ç•Œé¢
- æ”¯æŒè¿è§„æ¬¡æ•°é˜ˆå€¼å’Œç¦å°æ—¶é•¿çš„åŠ¨æ€é…ç½®
- æ·»åŠ é¢„è®¾é…ç½®é€‰é¡¹ï¼šè½»åº¦/é»˜è®¤/å®½æ¾/ä¸¥æ ¼å››ç§ç­–ç•¥

#### ğŸ”§ åç«¯ç³»ç»Ÿå¢å¼º
**APIæ¥å£å®Œå–„**
- `GET /api/stats/autoban-config` - è·å–å½“å‰è‡ªåŠ¨ç¦å°è®¾ç½®
- `PUT /api/stats/autoban-config` - æ›´æ–°è¿è§„é˜ˆå€¼å’Œç¦å°æ—¶é•¿
- `POST /api/stats/autoban-config/reset` - é‡ç½®ä¸ºé»˜è®¤é…ç½®
- å®Œæ•´çš„å‚æ•°éªŒè¯ï¼šè¿è§„æ¬¡æ•°1-100æ¬¡ï¼Œç¦å°æ—¶é•¿1-8760å°æ—¶

**æ•°æ®åº“ç»“æ„å‡çº§**
- æ‰©å±• `system_configs` è¡¨æ”¯æŒ `AUTOBAN` é…ç½®ç±»å‹
- ä¿®æ”¹å­—æ®µç±»å‹ä»¥æ”¯æŒç®€å•å€¼å­˜å‚¨å’Œæ£€ç´¢
- æ·»åŠ é…ç½®æ›´æ–°æ—¶é—´è¿½è¸ªæœºåˆ¶

**æ™ºèƒ½åŒ–è¿è§„ç®¡ç†**
- `updateViolationCount` å‡½æ•°é‡æ„ï¼Œæ”¯æŒé…ç½®åŒ–å‚æ•°
- `getAutoBanConfig` å‡½æ•°æä¾›ç¼“å­˜å’Œé»˜è®¤å€¼æœºåˆ¶
- æ”¯æŒå®Œå…¨ç¦ç”¨è‡ªåŠ¨ç¦å°åŠŸèƒ½çš„é€‰é¡¹
- åŠ¨æ€é˜ˆå€¼æ£€æµ‹å’Œå¯é…ç½®ç¦å°æ—¶é•¿

#### ğŸ¨ å‰ç«¯ç®¡ç†ç•Œé¢å‡çº§
**è‡ªåŠ¨ç¦å°é…ç½®é¡µé¢**
- åœ¨å†…å®¹å®¡æ ¸ç®¡ç†é¡µé¢æ–°å¢"è‡ªåŠ¨ç¦å°è®¾ç½®"æ ‡ç­¾é¡µ
- å“åº”å¼è¡¨å•è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨ç«¯æ“ä½œ
- å®æ—¶å‚æ•°éªŒè¯å’Œé”™è¯¯æç¤ºç³»ç»Ÿ
- é¢„è®¾é…ç½®æŒ‰é’®ï¼šå¿«é€Ÿåº”ç”¨å¸¸ç”¨ç¦å°ç­–ç•¥

**ç”¨æˆ·ä½“éªŒä¼˜åŒ–**
- è¯¦ç»†çš„é…ç½®è¯´æ˜å’Œä½¿ç”¨æŒ‡å¯¼
- æœ€åæ›´æ–°æ—¶é—´æ˜¾ç¤º
- é‡ç½®ç¡®è®¤å¯¹è¯æ¡†é˜²è¯¯æ“ä½œ
- ç°ä»£åŒ–çš„UIè®¾è®¡å’Œäº¤äº’åŠ¨ç”»

#### ğŸ“Š åŠŸèƒ½éªŒè¯æµ‹è¯•
**å®Œæ•´æµ‹è¯•è¦†ç›–**
- APIæ¥å£åŠŸèƒ½éªŒè¯ï¼šé…ç½®è¯»å–ã€æ›´æ–°ã€é‡ç½®
- è‡ªåŠ¨ç¦å°é€»è¾‘æµ‹è¯•ï¼šé˜ˆå€¼è§¦å‘å’Œæ—¶é•¿æ§åˆ¶
- å‰ç«¯ç•Œé¢æµ‹è¯•ï¼šè¡¨å•éªŒè¯å’Œç”¨æˆ·äº¤äº’
- é›†æˆæµ‹è¯•ï¼šç«¯åˆ°ç«¯å·¥ä½œæµç¨‹éªŒè¯

**æµ‹è¯•ç»“æœç¡®è®¤**
- âœ… é…ç½®åŠ¨æ€æ›´æ–°ï¼š2æ¬¡è¿è§„/1å°æ—¶ç¦å°ç­–ç•¥ç”Ÿæ•ˆ
- âœ… è‡ªåŠ¨ç¦å°è§¦å‘ï¼šè¾¾åˆ°é˜ˆå€¼ç”¨æˆ·è¢«æ­£ç¡®ç¦ç”¨
- âœ… ç¦ç”¨çŠ¶æ€æ£€æŸ¥ï¼šè¢«ç¦å°ç”¨æˆ·æ— æ³•ç»§ç»­ä½¿ç”¨æœåŠ¡
- âœ… é…ç½®æŒä¹…åŒ–ï¼šé‡å¯æœåŠ¡åé…ç½®ä¿æŒæœ‰æ•ˆ

#### ğŸš€ æŠ€æœ¯æ”¹è¿›
**ä»£ç è´¨é‡æå‡**
- æ¨¡å—åŒ–è®¾è®¡ï¼šé…ç½®ç®¡ç†é€»è¾‘ç‹¬ç«‹å°è£…
- é”™è¯¯å¤„ç†å®Œå–„ï¼šæ•°æ®åº“å¼‚å¸¸å’ŒAPIé”™è¯¯å¤„ç†
- ç±»å‹å®‰å…¨ï¼šå®Œæ•´çš„å‚æ•°éªŒè¯å’Œç±»å‹è½¬æ¢
- æ€§èƒ½ä¼˜åŒ–ï¼šé…ç½®ç¼“å­˜æœºåˆ¶å‡å°‘æ•°æ®åº“æŸ¥è¯¢

**å®‰å…¨æ€§å¢å¼º**
- å‚æ•°è¾¹ç•Œæ£€æŸ¥ï¼šé˜²æ­¢å¼‚å¸¸å€¼å¯¼è‡´ç³»ç»Ÿé—®é¢˜
- äº‹åŠ¡å¤„ç†ï¼šç¡®ä¿é…ç½®æ›´æ–°çš„åŸå­æ€§
- é»˜è®¤å€¼æœºåˆ¶ï¼šé…ç½®è¯»å–å¤±è´¥æ—¶çš„é™çº§å¤„ç†

---

### 2025-09-13 - v1.4.1 å®¡æ ¸è·¯ç”±è¯†åˆ«ä¸é…ç½®ç²¾ç®€ï¼ˆå·²å›é€€ï¼Œä»…ä¿ç•™"è®°å½•åŸå§‹è·¯ç”±"å˜æ›´ï¼‰

æœ¬æ¬¡ç‰ˆæœ¬å˜æ›´å·²å›é€€ï¼Œä¿ç•™çš„å”¯ä¸€æ”¹åŠ¨ï¼šå†…å®¹å®¡æ ¸ä¸­é—´ä»¶è®°å½•åŸå§‹è·¯ç”±ï¼ˆé€šè¿‡ `req.baseUrl/originalUrl` åˆ†æï¼‰ï¼Œå…¶ä½™è·¯ç”±ä¸­é—´ä»¶ã€è¿è¡Œæ—¶ DB ä¼˜å…ˆç­‰è°ƒæ•´å‡å·²æ’¤é”€ã€‚

### 2025-09-13 - v1.4.0 ç³»ç»Ÿä¼˜åŒ–ä¸é…ç½®ç®¡ç†å‡çº§

#### ğŸ—‚ï¸ é…ç½®æ–‡ä»¶ç»“æ„ä¼˜åŒ–
**é…ç½®æ–‡ä»¶ç»Ÿä¸€ç®¡ç†**
- åˆ›å»ºä¸“ç”¨ `config/` æ–‡ä»¶å¤¹ï¼Œæ•´ç†æ‰€æœ‰é…ç½®æ–‡ä»¶
- ç»Ÿä¸€æ–‡ä»¶è·¯å¾„ï¼šæ‰€æœ‰ `.txt` å’Œ `.json` é…ç½®æ–‡ä»¶ç§»è‡³ `config/` ç›®å½•
- æ›´æ–°ä»£ç å¼•ç”¨ï¼š`index.js` å’Œ `db/index.js` ä¸­çš„é…ç½®è·¯å¾„å…¨éƒ¨æ›´æ–°
- ä¿ç•™æ ¸å¿ƒæ–‡ä»¶ï¼š`package.json` å’Œ `é”™è¯¯ç .txt` ç•™åœ¨æ ¹ç›®å½•

**æ•°æ®åº“é…ç½®ç®¡ç†ç³»ç»Ÿ**
- å®ç°æ··åˆé…ç½®åŠ è½½ç­–ç•¥ï¼šæ–‡ä»¶é…ç½® + æ•°æ®åº“å­˜å‚¨
- æ–‡ä»¶è§„åˆ™ä¼˜å…ˆçº§è®¾ä¸º1ï¼Œæ•°æ®åº“è§„åˆ™é»˜è®¤ä¼˜å…ˆçº§100
- é…ç½®åŒæ­¥åŠŸèƒ½ï¼šä¸€é”®åŒæ­¥æ–‡ä»¶é…ç½®åˆ°æ•°æ®åº“
- å‰ç«¯é…ç½®ç®¡ç†ç•Œé¢ï¼šå¯è§†åŒ–CRUDæ“ä½œï¼Œæ”¯æŒè§„åˆ™ç±»å‹ç­›é€‰

**å‰ç«¯é…ç½®ç®¡ç†é¡µé¢**
- å®Œæ•´çš„é…ç½®è§„åˆ™ç®¡ç†ç•Œé¢ (`ConfigManagement.vue`)
- è§†è§‰åŒºåˆ†ï¼šæ–‡ä»¶è§„åˆ™ï¼ˆç°è‰²èƒŒæ™¯ + "æ–‡ä»¶"æ ‡ç­¾ + åªè¯»ï¼‰vs æ•°æ®åº“è§„åˆ™ï¼ˆå¯ç¼–è¾‘ï¼‰
- è§„åˆ™ç±»å‹åˆ†ç±»ï¼šæ•æ„Ÿè¯ã€é»‘åå•ã€ç™½åå•ã€ç”¨æˆ·é™åˆ¶ã€æ¨¡å‹è¿‡æ»¤ç­‰
- APIæ¥å£å®Œå–„ï¼šåˆ†é¡µæŸ¥è¯¢ã€æ–°å¢ã€ç¼–è¾‘ã€åˆ é™¤ã€æ–‡ä»¶åŒæ­¥

#### âš¡ ä¸­é—´ä»¶æ‰§è¡Œé¡ºåºä¼˜åŒ–
**å†…å®¹å®¡æ ¸ä½ç½®è°ƒæ•´**
- **è°ƒæ•´å‰**ï¼šå†…å®¹å®¡æ ¸åœ¨ç¬¬3ä½æ‰§è¡Œï¼ˆè¿‡æ—©è°ƒç”¨å¤–éƒ¨APIï¼‰
- **è°ƒæ•´å**ï¼šå†…å®¹å®¡æ ¸ç§»è‡³æ ¡éªŒé“¾æœ«å°¾ï¼Œä½œä¸ºæœ€åé˜²çº¿
- **ä¼˜åŒ–æ•ˆæœ**ï¼šå‡å°‘ä¸å¿…è¦çš„APIè°ƒç”¨ï¼Œæå‡ç³»ç»Ÿæ•ˆç‡
- **æ ¡éªŒé¡ºåº**ï¼šé»‘åå• â†’ æ•æ„Ÿè¯ â†’ æ­£åˆ™ â†’ ä¸šåŠ¡é€»è¾‘ â†’ é™æµ â†’ å†…å®¹å®¡æ ¸ â†’ ä»£ç†è½¬å‘

**æ€§èƒ½æå‡éªŒè¯**
- æ•æ„Ÿè¯è¯·æ±‚åœ¨å‰ç½®æ ¡éªŒè¢«æ‹¦æˆªï¼Œä¸è§¦å‘å†…å®¹å®¡æ ¸API
- æ­£å¸¸è¯·æ±‚é€šè¿‡æ‰€æœ‰å‰ç½®æ ¡éªŒåï¼Œæ‰æ‰§è¡Œå†…å®¹å®¡æ ¸
- ç³»ç»Ÿæ—¥å¿—æ¸…æ™°æ˜¾ç¤ºæ ¡éªŒæ‰§è¡Œé¡ºåºï¼Œä¾¿äºè°ƒè¯•åˆ†æ

#### ğŸ› ï¸ APIæ¥å£ä¿®å¤
**æŸ¥è¯¢å‚æ•°å¤„ç†ä¼˜åŒ–**
- ä¿®å¤ç©ºå­—ç¬¦ä¸²å‚æ•°é—®é¢˜ï¼šç©º `rule_type=` ä¸å†è¢«å½“ä½œæœ‰æ•ˆè¿‡æ»¤æ¡ä»¶
- APIæŸ¥è¯¢ç»“æœï¼šä»0æ¡è®°å½•ä¿®å¤ä¸ºæ­£ç¡®è¿”å›19æ¡é…ç½®è§„åˆ™
- å‚æ•°éªŒè¯å¢å¼ºï¼š`trim()` æ£€æŸ¥ç¡®ä¿ç©ºå­—ç¬¦ä¸²è¢«å¿½ç•¥

#### ğŸ“‹ é…ç½®æ–‡ä»¶æ–°ç»“æ„
```
config/
â”œâ”€â”€ BlacklistedUsers.txt      # ç”¨æˆ·é»‘åå•
â”œâ”€â”€ BlacklistedIPs.txt        # IPé»‘åå•  
â”œâ”€â”€ Sensitive.txt             # æ•æ„Ÿè¯åˆ—è¡¨
â”œâ”€â”€ whitelist.json           # ç™½åå•é…ç½®
â”œâ”€â”€ restrictedUsers.json     # ç”¨æˆ·é™åˆ¶é…ç½®
â”œâ”€â”€ sensitive_patterns.json  # æ•æ„Ÿæ­£åˆ™æ¨¡å¼
â””â”€â”€ filterConfig.json        # æ¨¡å‹è¿‡æ»¤é…ç½®
```

#### ğŸ”§ æŠ€æœ¯æ”¹è¿›
**ä»£ç è´¨é‡ä¼˜åŒ–**
- ç»Ÿä¸€é…ç½®æ–‡ä»¶è·¯å¾„ç®¡ç†
- APIæŸ¥è¯¢é€»è¾‘ä¼˜åŒ–å’Œå‚æ•°éªŒè¯
- ä¸­é—´ä»¶æ‰§è¡Œé¡ºåºé‡æ„
- é…ç½®ç®¡ç†å™¨ç¼“å­˜æœºåˆ¶å®Œå–„

**ç³»ç»Ÿç¨³å®šæ€§**
- é…ç½®åŠ è½½å®¹é”™å¤„ç†ï¼šæ•°æ®åº“å¤±è´¥æ—¶å›é€€åˆ°æ–‡ä»¶åŠ è½½
- æ··åˆé…ç½®ç­–ç•¥ï¼šç¡®ä¿ç³»ç»Ÿåœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½èƒ½æ­£å¸¸è¿è¡Œ
- é”™è¯¯æ—¥å¿—è¯¦ç»†è®°å½•ï¼šä¾¿äºé—®é¢˜å®šä½å’Œè°ƒè¯•

---

### 2025-09-13 - v1.3.0 é‡å¤§æ›´æ–°ï¼šå®Œæ•´å®¡æ ¸ç®¡ç†ç³»ç»Ÿ

#### ğŸš€ åç«¯ç³»ç»Ÿå¢å¼º
**æ•°æ®åº“æ¶æ„å‡çº§**
- æ–°å¢ `moderation_logs` è¡¨ï¼šå®Œæ•´è®°å½•æ‰€æœ‰å®¡æ ¸ç»“æœï¼Œæ”¯æŒå†…å®¹å“ˆå¸Œå»é‡
- æ–°å¢ `user_ip_flags` è¡¨ï¼šç”¨æˆ·/IPè¿è§„è®¡æ•°ä¸ç¦ç”¨ç®¡ç†
- å®Œæ•´çš„ç´¢å¼•ç­–ç•¥ï¼šæå‡æŸ¥è¯¢æ€§èƒ½ï¼Œæ”¯æŒå¤§æ•°æ®é‡
- å¤–é”®çº¦æŸè®¾è®¡ï¼šä¿è¯æ•°æ®ä¸€è‡´æ€§å’Œå®Œæ•´æ€§

**å†…å®¹å®¡æ ¸ä¸­é—´ä»¶å‡çº§**
- **æ•°æ®åº“é›†æˆ**ï¼šæ‰€æœ‰å®¡æ ¸ç»“æœè‡ªåŠ¨å…¥åº“ï¼Œæ”¯æŒå†å²è¿½è¸ª
- **æ™ºèƒ½ç”¨æˆ·è¯†åˆ«**ï¼šå…¼å®¹å¤šç§è¯·æ±‚æ ¼å¼çš„ç”¨æˆ·IDå’ŒIPæå–
- **è‡ªåŠ¨è¿è§„ç®¡ç†**ï¼š5æ¬¡è¿è§„è‡ªåŠ¨ç¦ç”¨24å°æ—¶ï¼Œæ”¯æŒé€’è¿›å¼å¤„ç½š
- **æ€§èƒ½ä¼˜åŒ–**ï¼šç¼“å­˜+æ•°æ®åº“åŒé‡å­˜å‚¨ï¼Œæ‰¹é‡æ“ä½œå‡å°‘å»¶è¿Ÿ

**ç®¡ç†APIå®Œæ•´å®ç°**
- å®¡æ ¸è®°å½•APIï¼šåˆ†é¡µæŸ¥è¯¢ã€å¤šç»´åº¦ç­›é€‰ã€è¯¦æƒ…æŸ¥çœ‹
- ç”¨æˆ·/IPç®¡ç†APIï¼šç¦ç”¨/è§£ç¦æ“ä½œã€æ‰¹é‡ç®¡ç†
- ç»Ÿè®¡åˆ†æAPIï¼šæ¦‚è§ˆæ•°æ®ã€è¶‹åŠ¿åˆ†æã€é£é™©åˆ†å¸ƒ
- å›¾è¡¨æ•°æ®APIï¼šè¿è§„è¶‹åŠ¿ã€çƒ­åŠ›å›¾ã€æ¨¡å‹ç»Ÿè®¡

#### ğŸ¨ å‰ç«¯ç•Œé¢å…¨é¢é‡æ„
**ç°ä»£ä¼ä¸šçº§è®¾è®¡**
- **ä¾§è¾¹æ å¯¼èˆª**ï¼šæ·±è‰²ä¸»é¢˜ + å›¾æ ‡åŒ–èœå•ï¼Œå®½åº¦ä¼˜åŒ–200px
- **é¡¶éƒ¨å¯¼èˆª**ï¼šé¢åŒ…å±‘å¯¼èˆª + ç”¨æˆ·ä¸‹æ‹‰èœå• + é€šçŸ¥ç³»ç»Ÿ
- **å“åº”å¼å¸ƒå±€**ï¼šå®Œæ•´ç§»åŠ¨ç«¯é€‚é…ï¼Œåª’ä½“æŸ¥è¯¢ä¼˜åŒ–
- **è§†è§‰è®¾è®¡**ï¼šèš‚èšè®¾è®¡è§„èŒƒé…è‰²ï¼Œä¸“ä¸šä¼ä¸šé£æ ¼

**å®Œæ•´å®¡æ ¸ç®¡ç†ç•Œé¢**
- **å®¡æ ¸è®°å½•ç®¡ç†**ï¼šè¡¨æ ¼å±•ç¤ºã€å®æ—¶ç­›é€‰ã€è¯¦æƒ…å¼¹çª—
- **ç”¨æˆ·/IPç®¡ç†**ï¼šè¿è§„ç»Ÿè®¡ã€ç¦ç”¨æ§åˆ¶ã€çŠ¶æ€è¿½è¸ª
- **æ•°æ®å¯è§†åŒ–**ï¼šEChartså›¾è¡¨ç»„ä»¶ï¼Œäº¤äº’å¼æ•°æ®å±•ç¤º
- **ç»Ÿè®¡åˆ†æé¡µé¢**ï¼šå¤šç»´åº¦å›¾è¡¨ã€å®æ—¶æ•°æ®åˆ·æ–°

**å›¾è¡¨ç»„ä»¶ç³»ç»Ÿ**
- `ViolationTrendsChart`ï¼šè¿è§„è¶‹åŠ¿çº¿å›¾ï¼Œæ”¯æŒæ—¶é—´èŒƒå›´é€‰æ‹©
- `RiskDistributionChart`ï¼šé£é™©ç±»å‹é¥¼å›¾ï¼Œå¯åˆ‡æ¢ç­‰çº§/ç±»å‹è§†å›¾
- `HourlyHeatmapChart`ï¼š24å°æ—¶çƒ­åŠ›å›¾ï¼Œæ—¶æ®µé£é™©åˆ†æ
- æ‰€æœ‰å›¾è¡¨æ”¯æŒå“åº”å¼ã€æ‚¬æµ®æç¤ºã€å›¾ä¾‹äº¤äº’

#### ğŸ› ï¸ æŠ€æœ¯æ¶æ„ä¼˜åŒ–
**å®‰å…¨é˜²æŠ¤å¢å¼º**
- è‡ªåŠ¨ç¦ç”¨æœºåˆ¶ï¼šæ™ºèƒ½è¯†åˆ«é¢‘ç¹è¿è§„ç”¨æˆ·
- æ•°æ®å®Œæ•´æ€§ï¼šäº‹åŠ¡å¤„ç†ï¼Œé”™è¯¯ä¸å½±å“ä¸»æµç¨‹
- æ€§èƒ½ä¼˜åŒ–ï¼šSQLæŸ¥è¯¢ä¼˜åŒ–ï¼Œæ‰¹é‡æ“ä½œå‡å°‘IO

**ä»£ç è´¨é‡æå‡**
- Vue 3 Composition APIï¼šç°ä»£åŒ–ç»„ä»¶æ¶æ„
- TypeScriptç±»å‹å®‰å…¨ï¼šæ¥å£å®šä¹‰æ¸…æ™°
- é”™è¯¯å¤„ç†å®Œå–„ï¼šæ•°æ®åº“å¼‚å¸¸é™çº§å¤„ç†
- æ—¥å¿—ç³»ç»Ÿå¢å¼ºï¼šè¯¦ç»†çš„å®¡æ ¸æµç¨‹æ—¥å¿—

#### ğŸ“Š åŠŸèƒ½ç‰¹æ€§
**ç®¡ç†å‘˜æ“ä½œ**
- å®æ—¶æŸ¥çœ‹æ‰€æœ‰å®¡æ ¸è®°å½•å’Œè¿è§„ç»Ÿè®¡
- æ‰‹åŠ¨ç¦ç”¨/è§£ç¦ç”¨æˆ·æˆ–IPåœ°å€
- è®¾ç½®ç¦ç”¨æ—¶é•¿ï¼ˆå°æ—¶çº§ç²¾ç¡®æ§åˆ¶ï¼‰
- å¯¼å‡ºå®¡æ ¸æŠ¥å‘Šï¼ˆå¼€å‘ä¸­ï¼‰

**æ•°æ®åˆ†æ**
- è¿è§„è¶‹åŠ¿åˆ†æï¼šæ—¥ã€å‘¨ã€æœˆç»´åº¦ç»Ÿè®¡
- é£é™©ç±»å‹åˆ†å¸ƒï¼šé¥¼å›¾å±•ç¤ºé«˜å±å†…å®¹ç±»å‹
- æ—¶æ®µåˆ†æï¼š24å°æ—¶çƒ­åŠ›å›¾è¯†åˆ«é«˜é£é™©æ—¶æ®µ
- æ¨¡å‹ç»Ÿè®¡ï¼šä¸åŒAIæ¨¡å‹çš„è¿è§„ç‡å¯¹æ¯”

---

## ğŸš€ ç‰ˆæœ¬æ›´æ–°è®°å½•

### 2025-10-13 - v1.10.1ï¼šä¼šè¯è¿½è¸ªä¸å›¾ç‰‡å“åº”ä¿®å¤

#### ğŸ”§ æ ¸å¿ƒæ”¹åŠ¨
- `loggingMiddleware.js` åœ¨è¯·æ±‚ç”Ÿå‘½å‘¨æœŸæ—©æœŸåŒæ­¥å†™å…¥ `conversation_id` ä¸ä¼šè¯çŠ¶æ€ï¼Œä¿éšœåç»­ä¸­é—´ä»¶å¤ç”¨ã€‚
- `responseInterceptorMiddleware.js` é‡æ„å“åº”è§£æï¼Œç»Ÿä¸€å¤„ç†æ–‡æœ¬ä¸å¤šæ¨¡æ€ç»“æœï¼Œæ–°å¢ `normalizeGeneratedImages()` å°† SiliconFlowã€Cloudflare ç­‰å›¾ç‰‡ç”Ÿæˆç»“æœè½¬æˆæ ‡å‡† `image_url` æ•°ç»„å¹¶å†™å…¥ä¼šè¯æ—¥å¿—ã€‚
- `statsRoutes.js` çš„ `/request/:id/conversation-logs` æ¥å£æ”¹ä¸ºä½¿ç”¨ `last_request_id` å…³è”æœ€æ–°è¯·æ±‚ï¼Œå¹¶æ–°å¢å¤šå±‚è§£æ/å…œåº•é€»è¾‘ï¼Œç¡®ä¿â€œæœ¬æ¬¡è¯·æ±‚â€å¯å±•ç¤ºå®Œæ•´å¯¹è¯å†…å®¹ã€‚

#### ğŸ ç¼ºé™·ä¿®å¤
- è§£å†³è¯·æ±‚è¯¦æƒ…å¼¹çª—ä¸­ä¼šè¯é‡å¤ã€ç¼ºå¤±çš„é—®é¢˜ï¼Œä¿®å¤å›¾ç‰‡ç”Ÿæˆè¯·æ±‚è¢«æ¸²æŸ“ä¸º `[Generated Images]` çš„å ä½æ–‡æœ¬ã€‚
- ä¿®æ­£åŒ¿å/æ™®é€šç”¨æˆ·åœ¨ç¼ºå¤± `conversation_id` åœºæ™¯ä¸‹çš„å†…å®¹å›å¡«ï¼Œé¿å…â€œæš‚æ— å¯¹è¯è®°å½•â€ã€‚

#### ğŸ“¦ å…¼å®¹æ€§è¯´æ˜
- æ•°æ®åº“ç»“æ„æ— éœ€è¿ç§»ï¼Œæ²¿ç”¨ v1.10.0 æ—¢æœ‰å­—æ®µã€‚
- åˆ é™¤ä¸´æ—¶è°ƒè¯•æ–‡æ¡£ `CONVERSATION_MERGE_FIX_PLAN.md`ï¼Œé¿å…ä¸ç°è¡Œå®ç°å†²çªã€‚

### 2025-09-14 - v1.6.0ï¼šè¯·æ±‚ä½“ä¿®æ”¹è§„åˆ™ç®¡ç†ç³»ç»Ÿ

#### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½å‡çº§
**æ•°æ®åº“é…ç½®åŒ–çš„è¯·æ±‚ä½“ä¿®æ”¹ç³»ç»Ÿ**
- å°†åŸæœ¬ç¡¬ç¼–ç çš„è¯·æ±‚ä½“ä¿®æ”¹é€»è¾‘è¿ç§»åˆ°æ•°æ®åº“é©±åŠ¨çš„åŠ¨æ€é…ç½®ç³»ç»Ÿ
- æ”¯æŒé€šè¿‡ç®¡ç†ç•Œé¢å®æ—¶é…ç½®å„ç§AIæ¨¡å‹çš„è¯·æ±‚ä½“ä¿®æ”¹è§„åˆ™
- å®ç°è§„åˆ™ä¼˜å…ˆçº§æ’åºã€çµæ´»çš„æ¡ä»¶åŒ¹é…å’Œå¤šæ ·åŒ–çš„æ“ä½œç±»å‹

#### ğŸ”§ åç«¯æ¶æ„é‡æ„
**æ•°æ®åº“å…¼å®¹æ€§å‡çº§ (db/index.js)**
- æ–°å¢ `system_configs` è¡¨çš„ `config_type` ENUM å­—æ®µå…¼å®¹æ€§æ›´æ–°
- æ”¯æŒ `REQUEST_BODY_MODIFY` å’Œ `AUTOBAN` é…ç½®ç±»å‹
- å®ç°å¹³æ»‘çš„æ•°æ®åº“ç»“æ„å‡çº§ï¼Œç¡®ä¿ç”Ÿäº§ç¯å¢ƒé›¶åœæœºéƒ¨ç½²
- æ·»åŠ  `getRequestBodyModifyRules()` å‡½æ•°è·å–è§„åˆ™é…ç½®

**å…¨æ–°çš„è¯·æ±‚ä½“ä¿®æ”¹ä¸­é—´ä»¶ (modules/modifyRequestBodyMiddleware.js)**
- å®Œå…¨é‡æ„ä¸ºæ•°æ®åº“é©±åŠ¨çš„åŠ¨æ€è§„åˆ™å¼•æ“
- æ”¯æŒå¤šç§æ¨¡å‹åŒ¹é…æ–¹å¼ï¼šç²¾ç¡®åŒ¹é…ã€é€šé…ç¬¦ (*)ã€å‰ç¼€åŒ¹é…ã€åŒ…å«åŒ¹é…
- å®ç°ä¸‰ç§æ¡ä»¶ç±»å‹ï¼šå§‹ç»ˆåŒ¹é…ã€å‚æ•°å­˜åœ¨æ£€æµ‹ã€å‚æ•°å€¼åŒ¹é…
- æ”¯æŒä¸‰ç§æ“ä½œç±»å‹ï¼šè®¾ç½®å‚æ•°ã€åˆ é™¤å‚æ•°ã€å®Œå…¨æ›¿æ¢è¯·æ±‚ä½“
- é›†æˆ5åˆ†é’Ÿç¼“å­˜æœºåˆ¶ï¼Œä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
- æ”¯æŒæ¨¡æ¿å˜é‡æ›¿æ¢åŠŸèƒ½ ({{å˜é‡å}})

**RESTful API æ¥å£å®ç° (router/statsRoutes.js)**
- `GET /stats/request-body-rules` - è·å–è§„åˆ™åˆ—è¡¨ (æ”¯æŒåˆ†é¡µ/ç­›é€‰)
- `POST /stats/request-body-rules` - æ·»åŠ æ–°è§„åˆ™
- `PUT /stats/request-body-rules/:id` - æ›´æ–°è§„åˆ™ (æ”¯æŒçŠ¶æ€åˆ‡æ¢)
- `DELETE /stats/request-body-rules/:id` - åˆ é™¤è§„åˆ™
- `POST /stats/request-body-rules/import-current` - å¯¼å…¥ç°æœ‰ç¡¬ç¼–ç è§„åˆ™

#### ğŸ¨ å‰ç«¯ç®¡ç†ç•Œé¢
**è¯·æ±‚ä½“ä¿®æ”¹è§„åˆ™ç®¡ç†é¡µé¢**
- åœ¨å†…å®¹å®¡æ ¸ç®¡ç†é¡µé¢æ–°å¢"è¯·æ±‚ä½“ä¿®æ”¹è§„åˆ™"æ ‡ç­¾é¡µ
- å®ç°è§„åˆ™åˆ—è¡¨çš„è¡¨æ ¼åŒ–å±•ç¤ºï¼Œæ”¯æŒåˆ†é¡µæµè§ˆ
- æä¾›è§„åˆ™çš„åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤å’ŒçŠ¶æ€åˆ‡æ¢åŠŸèƒ½
- é›†æˆ"å¯¼å…¥ç°æœ‰è§„åˆ™"åŠŸèƒ½ï¼Œä¸€é”®è¿ç§»ç¡¬ç¼–ç é…ç½®

**æ™ºèƒ½è¡¨å•è®¾è®¡**
- è§„åˆ™åç§°ã€æ¨¡å‹åŒ¹é…æ¨¡å¼çš„çµæ´»é…ç½®
- æ¡ä»¶ç±»å‹é€‰æ‹©ï¼šå§‹ç»ˆåŒ¹é…/å‚æ•°å­˜åœ¨/å‚æ•°å€¼åŒ¹é…
- æ“ä½œç±»å‹é€‰æ‹©ï¼šè®¾ç½®å‚æ•°/åˆ é™¤å‚æ•°/æ›¿æ¢å…¨éƒ¨
- JSONé…ç½®ç¼–è¾‘å™¨ï¼Œæ”¯æŒè¯­æ³•é«˜äº®å’Œæ ¼å¼éªŒè¯
- å®æ—¶é¢„è§ˆå’Œé…ç½®ç¤ºä¾‹æç¤º

#### ğŸ› ï¸ æŠ€æœ¯ç‰¹æ€§
**é«˜æ€§èƒ½ä¼˜åŒ–**
- è§„åˆ™ç¼“å­˜æœºåˆ¶ï¼š5åˆ†é’Ÿæœ¬åœ°ç¼“å­˜ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢
- æŒ‰éœ€åŠ è½½ï¼šä»…åœ¨åˆ‡æ¢æ ‡ç­¾é¡µæ—¶è¯·æ±‚æ•°æ®
- å¼‚æ­¥å¤„ç†ï¼šè§„åˆ™æ‰§è¡Œå¤±è´¥ä¸å½±å“ä¸»è¦ä¸šåŠ¡æµç¨‹

**çµæ´»çš„è§„åˆ™å¼•æ“**
```javascript
// æ”¯æŒçš„æ¨¡å‹åŒ¹é…ç¤ºä¾‹
'huggingface/*'     // é€šé…ç¬¦åŒ¹é…
'Baichuan*'         // å‰ç¼€åŒ¹é…
'*glm-4v*'         // åŒ…å«åŒ¹é…
'o3-mini'          // ç²¾ç¡®åŒ¹é…

// æ”¯æŒçš„æ“ä½œç±»å‹ç¤ºä¾‹
set_param: {top_p: 0.5}                    // è®¾ç½®å‚æ•°
delete_param: ['top_p', 'temperature']     // åˆ é™¤å‚æ•°
replace_body: {                            // æ›¿æ¢è¯·æ±‚ä½“
  input: '{{input}}',
  model: 'new-model',
  stream: false
}
```

**å‘ä¸‹å…¼å®¹ä¿è¯**
- ç°æœ‰ç¡¬ç¼–ç è§„åˆ™è‡ªåŠ¨è¿ç§»åˆ°æ•°æ®åº“
- ç”Ÿäº§ç¯å¢ƒå¯ä»¥å¹³æ»‘å‡çº§ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„
- æ•°æ®åº“ç»“æ„å˜æ›´é€šè¿‡ç‰ˆæœ¬æ£€æŸ¥è‡ªåŠ¨æ‰§è¡Œ

#### ğŸ“Š ç³»ç»Ÿç»Ÿè®¡
**ä»£ç è´¨é‡æå‡**
- åç«¯æ–°å¢ï¼š640+ è¡Œä»£ç ï¼Œé‡æ„ 39 è¡Œ
- å‰ç«¯æ–°å¢ï¼š585+ è¡Œä»£ç ï¼Œä¼˜åŒ– 4 è¡Œ
- æ¶‰åŠ 6 ä¸ªæ ¸å¿ƒæ–‡ä»¶çš„æ¶æ„çº§æ”¹è¿›

**åŠŸèƒ½è¦†ç›–èŒƒå›´**
- æ”¯æŒ 6 ç§é¢„è®¾è§„åˆ™çš„è‡ªåŠ¨å¯¼å…¥
- è¦†ç›–æ‰€æœ‰ä¸»æµ AI æ¨¡å‹çš„è¯·æ±‚ä½“å¤„ç†
- ç®¡ç†ç•Œé¢æ”¯æŒæ— é™è§„åˆ™æ•°é‡çš„é…ç½®

---

### 2025-09-13 - v1.5.0ï¼šè‡ªåŠ¨ç¦å°é…ç½®ç³»ç»Ÿ
- å®ç°å¯é…ç½®çš„è‡ªåŠ¨ç¦å°é˜ˆå€¼å’ŒæŒç»­æ—¶é—´
- æ·»åŠ ç®¡ç†ç•Œé¢çš„è‡ªåŠ¨ç¦å°è®¾ç½®æ ‡ç­¾é¡µ
- æ”¯æŒé¢„è®¾é…ç½®å’Œå®æ—¶å‚æ•°è°ƒæ•´

### 2025-09-11 - v1.2.0ï¼šå†…å®¹å®¡æŸ¥åŠŸèƒ½
- é›†æˆæ™ºè°±AIå†…å®¹å®‰å…¨API
- å®ç°å†…å®¹å®¡æŸ¥ä¸­é—´ä»¶
- æ”¯æŒå®æ—¶å†…å®¹é£é™©æ£€æµ‹

## ğŸ“š ç›¸å…³æ–‡æ¡£é“¾æ¥

- [æ™ºè°±AIå†…å®¹å®‰å…¨APIæ–‡æ¡£](https://docs.bigmodel.cn/api-reference/moderation)
- [Docker Composeå‚è€ƒ](https://docs.docker.com/compose/)
- [Express.jsä¸­é—´ä»¶æ–‡æ¡£](https://expressjs.com/en/guide/using-middleware.html)
- [Vue 3 å®˜æ–¹æ–‡æ¡£](https://vuejs.org/)
- [Element Plus ç»„ä»¶åº“](https://element-plus.org/)
- [ECharts æ•°æ®å¯è§†åŒ–](https://echarts.apache.org/)

---

**ç»´æŠ¤è¯´æ˜**: æ­¤æ–‡æ¡£è®°å½•äº†é¡¹ç›®çš„å®Œæ•´æ¶æ„å’Œæœ€æ–°å¼€å‘è¿›å±•ï¼Œå»ºè®®æ¯æ¬¡é‡å¤§æ›´æ–°ååŠæ—¶æ›´æ–°æ­¤æ–‡æ¡£ã€‚
